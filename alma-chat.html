<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <title>Alma - chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0a0a0b;
      --panel:#0f0f11;
      --panel-2:#141418;
      --fg:#f3f3f3;
      --fg-dim:#cfcfd3;
      --border:#26262b;
      --accent:#d4a017; /* amarelo torrado */
      --bubble-user:#1b1b21;
      --bubble-alma:#23232a;
      --shadow: 0 1px 0 rgba(255,255,255,0.03), 0 8px 24px rgba(0,0,0,0.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      display:flex; overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      width:310px; min-width:260px; max-width:360px;
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border-right:1px solid var(--border);
      display:flex; flex-direction:column;
    }
    .side-header{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(10,10,11,.98),rgba(10,10,11,.90));
      backdrop-filter: blur(6px);
    }
    .side-header img{
      width:72px; height:72px; border-radius:50%;
      box-shadow: var(--shadow);
      object-fit:cover;
    }

    .session-search{ padding:10px 12px; border-bottom:1px solid var(--border); }
    .session-search input{
      width:100%; padding:10px 12px; border-radius:8px;
      border:1px solid var(--border); background:#0e0e11; color:var(--fg);
      outline:none;
    }
    .session-search input::placeholder{ color:#8a8a92; }

    .side-actions{
      display:flex; gap:10px; align-items:center;
      color:var(--fg-dim); padding:10px 12px;
      border-bottom:1px solid var(--border);
    }
    .side-actions button{
      background:none; border:none; color:var(--fg);
      cursor:pointer; font-size:1rem; padding:4px 6px;
    }
    .side-actions button:hover{ color:var(--accent); }

    .sessions{ flex:1; overflow:auto; padding:10px; }
    .session{
      padding:10px 12px; border:1px solid var(--border);
      margin-bottom:8px; border-radius:10px; cursor:pointer;
      background: #111115; transition:background .15s,border-color .15s;
    }
    .session:hover{ background:#17171c; }
    .session.active{ background:#1b1b21; border-color:var(--accent); }
    .session .title{
      font-size:.95rem; color:var(--fg); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .session .meta{
      margin-top:4px; font-size:.75rem; color:#9a9aa1;
      display:flex; align-items:center; gap:8px;
    }
    .session .del{
      margin-left:auto; color:#a6a6ad; cursor:pointer; font-weight:600;
    }
    .session .del:hover{ color:#ff6363; }

    /* Main */
    .main{ flex:1; display:flex; flex-direction:column; min-height:0; }

    .messages{
      flex:1; overflow:auto;
      padding:18px 20px 24px;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(212,160,23,.05), transparent 60%);
      scroll-behavior:smooth;
      min-height:0;
      padding-bottom:110px;
    }

    .msg{ position:relative; max-width:980px; margin:0 auto 12px auto; display:flex; }
    .msg .bubble{
      padding:12px 16px; border-radius:14px; box-shadow: var(--shadow);
      font-size:1rem; line-height:1.55;
      border:1px solid rgba(255,255,255,0.06);
      word-break:break-word;
    }
    .msg.user{ justify-content:flex-start; }
    .msg.user .bubble{ background:var(--bubble-user); max-width:min(90%, 720px); white-space:pre-wrap; }

    .msg.alma{ justify-content:flex-end; }
    .msg.alma .bubble{
      background:var(--bubble-alma);
      margin-left:auto; max-width:min(90%, 720px);
    }

    .copy-btn{
      position:absolute; right:12px; bottom:8px;
      font-size:.78rem; color:#bdbdc6; cursor:pointer; user-select:none;
    }
    .copy-btn:hover{ color:var(--accent); }

    /* Composer */
    .input-bar{
      position:sticky; bottom:0; z-index:5;
      padding:12px;
      border-top:1px solid var(--border);
      background:linear-gradient(180deg,var(--panel-2),var(--panel));
      box-shadow: 0 -6px 16px rgba(0,0,0,.25);
    }
    .input-wrap{
      display:flex; max-width:980px; margin:0 auto;
      border:1px solid var(--border); border-radius:14px; overflow:hidden;
      background:#101014;
    }
    #prompt{
      flex:1; background:transparent; color:var(--fg);
      padding:14px 14px; font-size:1rem; border:none; outline:none;
    }
    .send-btn{
      min-width:64px;
      background:var(--accent); color:#000; border:none; font-size:1.2rem;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      padding:0 22px;
    }
    .send-btn:hover{ filter:brightness(1.05); }
    .send-btn:active{ transform:translateY(1px); }

    /* Scrollbars */
    .sessions::-webkit-scrollbar, .messages::-webkit-scrollbar { width:10px; }
    .sessions::-webkit-scrollbar-thumb, .messages::-webkit-scrollbar-thumb { background:#2a2a31; border-radius:10px; }
    .sessions::-webkit-scrollbar-track, .messages::-webkit-scrollbar-track { background:transparent; }

    /* Alma renderer (bonito, mas simples) */
    .alma-p{ margin:6px 0; }
    .alma-h{ font-weight:800; margin:10px 0 6px; }
    .alma-hr{ height:1px; background:rgba(255,255,255,0.10); margin:10px 0; border:0; }
    .alma-list{ margin:6px 0 6px 18px; padding:0; }
    .alma-list li{ margin:4px 0; }
    .alma-kv{ margin:6px 0; }
    .alma-note{ color:rgba(243,243,243,0.85); font-style:italic; margin:6px 0; }

    .bubble a{
      color:var(--accent);
      text-decoration:underline;
      text-underline-offset:3px;
    }

    /* Responsivo */
    @media (max-width: 1024px){
      .sidebar{ width:280px; }
      .side-header img{ width:64px; height:64px; }
      .messages{ padding:14px 14px 20px; padding-bottom:120px; }
    }
    @media (max-width: 820px){
      body{ flex-direction:column; }
      .sidebar{ width:100%; max-width:none; border-right:none; border-bottom:1px solid var(--border); }
      .sessions{ max-height:40vh; }
      .messages{ padding:14px; padding-bottom:130px; }
      .input-bar{ padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
      .input-wrap{ margin:0 6px; }
    }
    @media (max-width: 480px){
      .side-header img{ width:54px; height:54px; }
      .session-search{ padding:8px; }
      .side-actions{ padding:8px; }
      .sessions{ padding:8px; }
      .input-bar{ padding:8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
      .send-btn{ padding:0 18px; }
      .msg .bubble{ font-size:.98rem; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="side-header">
      <img src="/static/alma.png" alt="Alma">
    </div>

    <div class="session-search">
      <input id="search" placeholder="Procurar sessões…" oninput="renderSessions()">
    </div>

    <div class="side-actions">
      <button title="Nova sessão" onclick="newSession()">+</button>
      <button title="Limpar histórico local" onclick="clearLocal()">x</button>
    </div>

    <div id="sessions" class="sessions"></div>
  </aside>

  <main class="main">
    <div id="messages" class="messages"></div>

    <div class="input-bar">
      <div class="input-wrap">
        <input id="prompt" placeholder="Escreve aqui…" onkeydown="if(event.key==='Enter'){sendMsg()}">
        <button class="send-btn" onclick="sendMsg()">&#x3e;</button>
      </div>
    </div>
  </main>

<script>
/* ---------- Estado local ---------- */
let sessions = JSON.parse(localStorage.getItem("alma_sessions")||"[]");
let activeId = sessions.length ? sessions[0].id : null;

/* ---------- Util ---------- */
function saveSessions(){ localStorage.setItem("alma_sessions", JSON.stringify(sessions)); }
function byId(id){ return document.getElementById(id); }
function snippetFrom(text, n=48){
  const s=(text||"").replace(/\s+/g," ").trim();
  return s.length>n ? s.slice(0,n-1)+"…" : s || "Nova sessão";
}

/* ---------- Sessões ---------- */
function newSession(){
  const id = "s"+Date.now();
  const sess = { id, title:"Nova sessão", msgs:[], createdAt: Date.now() };
  sessions.unshift(sess);
  activeId = id;
  saveSessions();
  renderSessions();
  renderMsgs();
  byId("prompt").focus();
}

function delSession(id){
  sessions = sessions.filter(s=>s.id!==id);
  if(activeId===id) activeId = sessions.length ? sessions[0].id : null;
  saveSessions();
  renderSessions();
  renderMsgs();
}

function clearLocal(){
  if(!confirm("Apagar TODO o histórico local?")) return;
  sessions = []; activeId = null;
  saveSessions();
  renderSessions();
  renderMsgs();
}

function renderSessions(){
  const box = byId("sessions"); box.innerHTML="";
  const q = (byId("search").value||"").toLowerCase();
  sessions.forEach(s=>{
    const match = !q || (s.title||"").toLowerCase().includes(q);
    if(!match) return;
    const div = document.createElement("div");
    div.className = "session"+(s.id===activeId?" active":"");
    div.onclick = ()=>{ activeId=s.id; renderSessions(); renderMsgs(); };

    const title = document.createElement("div");
    title.className="title";
    title.textContent = s.title || "Nova sessão";

    const meta = document.createElement("div");
    meta.className="meta";
    const date = new Date(s.createdAt||Date.now()).toLocaleString();
    const count = (s.msgs||[]).length;

    const spanDate = document.createElement("span");
    spanDate.textContent = date;
    const spanCount = document.createElement("span");
    spanCount.textContent = count+" msg";

    const del = document.createElement("span");
    del.className="del"; del.title="Apagar sessão"; del.textContent="x";
    del.onclick = (ev)=>{ ev.stopPropagation(); delSession(s.id); };

    meta.appendChild(spanDate);
    meta.appendChild(spanCount);
    meta.appendChild(del);

    div.appendChild(title);
    div.appendChild(meta);
    box.appendChild(div);
  });
}

/* =========================================================
   Renderer ÚNICO (sem libs, sem tabelas)
   - preserva quebras
   - não inventa links
   - “Links dos produtos:” fica sempre bem, mesmo colado
   - linhas com pipes viram texto legível (não tabela)
   ========================================================= */

function escapeHtml(s){
  return (s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

function trimUrl(u){
  return (u||"").replace(/[)\]\}>,.;:!?]+$/g,"");
}

function looksBudget(text){
  const t=(text||"").toLowerCase();
  return t.includes("orçamento") || t.includes("orcamento") || t.includes("cotação") || t.includes("cotacao") || t.includes("total:");
}

/* Normaliza o bloco “Links dos produtos:” mesmo quando vem colado */
function normalizeLinksSection(raw){
  let t=(raw||"");
  // força newline depois do cabeçalho
  t = t.replace(/(Links dos produtos\s*:)\s*/ig, "$1\n");

  // casos colados tipo: "https://... - Nome — SKU"
  // transformamos em:
  // - Nome — SKU
  //   https://...
  t = t.replace(/(https?:\/\/[^\s]+)\s*[-–—]\s*([^\n]+)/g, (m, url, rest)=>{
    url = trimUrl(url);
    rest = (rest||"").trim();
    return "- " + rest + "\n  " + url;
  });

  // linhas com "  https://..." já ok; URLs soltas em linhas -> mete bullet se estiver dentro da secção
  const lines = t.replace(/\r\n/g,"\n").split("\n");
  const out=[];
  let inLinks=false;

  for(const line of lines){
    const s=line.trim();
    if(!s){
      out.push("");
      continue;
    }
    if(/^Links dos produtos\s*:/i.test(s)){
      inLinks=true;
      out.push("Links dos produtos:");
      continue;
    }
    if(inLinks){
      // se aparecer uma secção nova, sai
      if(/^(total:|nota:|itens:|próxima|indique|observa|condições)/i.test(s)){
        inLinks=false;
        out.push(line);
        continue;
      }
      // url solta -> vira "  url" (mantém associado ao item anterior se existir)
      if(/^https?:\/\//i.test(s)){
        out.push("  " + trimUrl(s));
        continue;
      }
      out.push(line);
      continue;
    }
    out.push(line);
  }
  return out.join("\n");
}

/* Linhas tipo tabela com pipes -> ficam legíveis */
function dePipe(text){
  const lines=(text||"").replace(/\r\n/g,"\n").split("\n");
  const out=[];
  for(const ln of lines){
    const s=ln.trim();
    // remove separadores de tabela
    if(s && s.includes("|") && /^(\|?\s*:?-{2,}\s*)+$/.test(s.replace(/[|]/g,"|"))){
      continue;
    }
    const pipeCount=(ln.match(/\|/g)||[]).length;
    if(pipeCount>=2){
      const parts = ln.split("|").map(x=>x.trim()).filter(Boolean);
      if(parts.length>=2){
        out.push("• " + parts.join(" — "));
        continue;
      }
    }
    out.push(ln);
  }
  return out.join("\n");
}

/* Linkifica apenas URLs reais (sem mexer no resto) */
function linkifyHtml(html){
  // (não mexe em tags porque nós controlamos o HTML que geramos)
  return html.replace(/(^|[\s>])(https?:\/\/[^\s<]+)/g, (m, lead, raw)=>{
    const url = trimUrl(raw);
    const tail = raw.slice(url.length);
    return lead + `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>` + escapeHtml(tail);
  });
}

/* Render adaptativo */
function renderAlma(raw){
  let t = (raw||"").replace(/\r\n/g,"\n").trimEnd();

  // limpa o “ver produto” solto no topo (caso apareça)
  t = t.replace(/^(?:\s*(?:[-–—]\s*)?ver produto\s*)\n+/i, "");

  // conserta bloco links + "pipes"
  t = normalizeLinksSection(t);
  t = dePipe(t);

  // blocos por parágrafos
  const blocks = t.split(/\n{2,}/);
  const parts = [];

  for(const block of blocks){
    const b = block.trimEnd();
    if(!b) continue;

    // headings simples
    if(/^\s*#{1,6}\s+/.test(b)){
      const title = b.replace(/^\s*#{1,6}\s+/,"").trim();
      parts.push(`<div class="alma-h">${escapeHtml(title)}</div>`);
      continue;
    }

    // separador
    if(/^\s*[-–—]{3,}\s*$/.test(b)){
      parts.push(`<hr class="alma-hr">`);
      continue;
    }

    // lista (linhas que começam por - ou •)
    const lines = b.split("\n");
    const isList = lines.filter(x=>x.trim()).every(x => /^(\s*[-•]\s+)/.test(x));
    if(isList){
      const items = lines
        .map(x=>x.replace(/^(\s*[-•]\s+)/,"").trim())
        .filter(Boolean)
        .map(x=>`<li>${linkifyHtml(escapeHtml(x))}</li>`)
        .join("");
      parts.push(`<ul class="alma-list">${items}</ul>`);
      continue;
    }

    // nota (iva/portes)
    if(/iva/i.test(b) && /portes?/i.test(b)){
      parts.push(`<div class="alma-note">${linkifyHtml(escapeHtml(b))}</div>`);
      continue;
    }

    // parágrafo normal (preserva \n com <br>)
    let html = escapeHtml(b);

    // bold/underline simples
    html = html
      .replace(/\*\*(.+?)\*\*/g, "<b>$1</b>")
      .replace(/__(.+?)__/g, "<u>$1</u>");

    // quebra de linha
    html = html.replace(/\n/g,"<br>");

    // linkify no fim
    html = linkifyHtml(html);

    parts.push(`<div class="alma-p">${html}</div>`);
  }

  // Se for orçamento e veio tudo “muito junto”, ainda assim fica legível pelos <div> e <br>.
  return parts.join("");
}

/* ---------- Mensagens ---------- */
function renderMsgs(){
  const s = sessions.find(x=>x.id===activeId);
  const box = byId("messages");
  box.innerHTML="";
  if(!s) return;

  s.msgs.forEach(m=>{
    const row=document.createElement("div");
    row.className="msg "+m.role;

    const bubble=document.createElement("div");
    bubble.className="bubble";

    if(m.role==="user"){
      bubble.textContent = (m.content||"");
      row.appendChild(bubble);
      box.appendChild(row);
      return;
    }

    // Alma: renderer único
    const raw = (m.content||"");
    bubble.innerHTML = renderAlma(raw);

    const copy=document.createElement("span");
    copy.className="copy-btn";
    copy.textContent="copiar";
    copy.onclick=()=>navigator.clipboard.writeText(raw);
    row.appendChild(bubble);
    row.appendChild(copy);

    box.appendChild(row);
  });

  box.scrollTop = box.scrollHeight;
}

function updateSessionTitleFromFirstUserMsg(sess){
  const firstUser = (sess.msgs||[]).find(m=>m.role==="user");
  if(firstUser){
    sess.title = snippetFrom(firstUser.content, 50);
  }
}

/* ---------- Enviar ---------- */
async function sendMsg(){
  const inp = byId("prompt");
  const txt = (inp.value||"").trim();
  if(!txt) return;
  inp.value = "";

  let s = sessions.find(x=>x.id===activeId);
  if(!s){ newSession(); s = sessions.find(x=>x.id===activeId); }

  s.msgs.push({role:"user", content:txt});
  if((s.title||"Nova sessão")==="Nova sessão") updateSessionTitleFromFirstUserMsg(s);
  saveSessions();
  renderSessions();
  renderMsgs();

  try{
    const res = await fetch("/ask", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ question: txt, user_id: activeId })
    });
    const j = await res.json();
    const ans = j.answer || JSON.stringify(j);
    s.msgs.push({role:"alma", content: ans});
  }catch(err){
    s.msgs.push({role:"alma", content: "Desculpa — não consegui responder agora. ("+err+")"});
  }finally{
    saveSessions();
    renderMsgs();
  }
}

/* ---------- Boot ---------- */
if(!activeId){ newSession(); } else { renderSessions(); renderMsgs(); }
</script>

  <script>
/* =========================================================
   Alma Chat — formatter patch (drop-in)
   Cola ESTE script no fim do HTML (antes de </body>).
   Objectivo:
   - Título (Orçamento...) a bold
   - Total destacado numa linha própria
   - Links no fim, 1 por linha
   - Preserva texto raw do backend (não inventa conteúdo)
   - Não rebenta o servidor (sem libs, sem eval)
   ========================================================= */

/* ---------- helpers seguros ---------- */
function byId(id){ return document.getElementById(id); }

function escapeHtml(s){
  return (s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

function trimUrl(u){
  return (u||"").replace(/[)\]\}>,.;:!?]+$/g,"");
}

function linkifyHtml(html){
  // html já escapado e/ou gerado por nós, por isso só linkifica URLs
  return html.replace(/(^|[\s>])(https?:\/\/[^\s<]+)/g, (m, lead, raw)=>{
    const url = trimUrl(raw);
    const tail = raw.slice(url.length);
    return lead + `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>` + escapeHtml(tail);
  });
}

function inlineMdSafe(escaped){
  // inline markdown mínimo sobre string já escapada
  return escaped
    .replace(/\*\*(.+?)\*\*/g, "<b>$1</b>")
    .replace(/__(.+?)__/g, "<u>$1</u>");
}

/* ---------- heurística orçamento ---------- */
function looksBudget(raw){
  const t=(raw||"").toLowerCase();
  return t.includes("orçamento") || t.includes("orcamento") || t.includes("total:");
}

/* ---------- normalização (sem reordenar conteúdo) ---------- */
function normalizeBudgetText(raw){
  let t = (raw||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");

  // força linhas/sectores essenciais para ficarem legíveis mesmo quando vêm colados
  t = t.replace(/\s+(Total:)/gi, "\n$1");
  t = t.replace(/\s+(Links dos produtos:)/gi, "\n\n$1\n");
  t = t.replace(/(Links dos produtos\s*:)\s*/ig, "$1\n");

  // garante que URLs começam em linha própria (quando vêm coladas a texto)
  t = t.replace(/([^\n])\s*(https?:\/\/)/g, "$1\n$2");

  // bullets colados
  t = t.replace(/([^\n])\s+[-–—•]\s+/g, "$1\n- ");

  // limpa excesso
  t = t.replace(/\n{3,}/g, "\n\n").trim();
  return t;
}

function renderBudget(raw){
  const t = normalizeBudgetText(raw);
  const lines = t.split("\n");

  let title = "";
  let total = "";
  let body = [];
  let links = [];
  let inLinks = false;

  for(let i=0;i<lines.length;i++){
    const line = (lines[i]||"").trim();
    const low = line.toLowerCase();

    if(!title && low.startsWith("orçamento")){
      title = line;
      continue;
    }

    if(low.startsWith("total:")){
      total = line;
      continue;
    }

    if(low.startsWith("links dos produtos:")){
      inLinks = true;
      continue;
    }

    if(inLinks){
      if(!line) continue;

      // Se a linha tem 1+ urls, extrai cada uma para 1 por linha
      const urls = line.match(/https?:\/\/\S+/gi) || [];
      if(urls.length){
        urls.forEach(u => links.push(trimUrl(u)));
      }else{
        // se veio só texto (ex: "Mono Cadeira — 100010"), mantém como “linha” (não inventa url)
        // mas para não poluir links, mete no body do orçamento (fica legível)
        body.push(line);
      }
      continue;
    }

    // corpo (preserva)
    if(line) body.push(line);
    else body.push(""); // mantém espaços
  }

  const parts = [];

  // inject de CSS (1x)
  if(!document.getElementById("alma-format-style")){
    const st = document.createElement("style");
    st.id = "alma-format-style";
    st.textContent = `
      .msg .bubble{ position:relative; }
      .msg.alma .bubble{ padding-bottom: 34px; }
      .copy-btn{
        position:absolute; right:12px; bottom:10px;
        font-size:.78rem; color:#bdbdc6; cursor:pointer; user-select:none;
      }
      .copy-btn:hover{ color: var(--accent, #d4a017); }

      .alma-p{ margin:6px 0; }
      .alma-budget-title{ font-weight:800; margin: 2px 0 10px; }
      .alma-budget-total{
        margin: 10px 0 0;
        padding-top: 10px;
        border-top: 1px solid rgba(255,255,255,0.12);
        font-weight: 800;
      }
      .alma-budget-links-title{
        margin: 12px 0 6px;
        font-weight: 700;
        color: rgba(243,243,243,0.92);
      }
      .alma-budget-link{ margin:4px 0; }
      .alma-budget-link a{ display:inline-block; max-width:100%; overflow-wrap:anywhere; }
    `;
    document.head.appendChild(st);
  }

  if(title){
    let h = inlineMdSafe(escapeHtml(title));
    h = linkifyHtml(h);
    parts.push(`<div class="alma-budget-title">${h}</div>`);
  }

  // corpo: preserva quebras vazias
  for(const ln of body){
    if(!ln){
      parts.push(`<div class="alma-p">&nbsp;</div>`);
      continue;
    }
    let p = inlineMdSafe(escapeHtml(ln));
    p = linkifyHtml(p);
    parts.push(`<div class="alma-p">${p}</div>`);
  }

  if(total){
    let tt = inlineMdSafe(escapeHtml(total));
    tt = linkifyHtml(tt);
    parts.push(`<div class="alma-budget-total">${tt}</div>`);
  }

  if(links.length){
    // dedupe simples mantendo ordem (não é “corrupção”; só evita spam visual)
    const seen = new Set();
    const uniq = [];
    for(const u of links){
      if(seen.has(u)) continue;
      seen.add(u);
      uniq.push(u);
    }

    parts.push(`<div class="alma-budget-links-title">Links dos produtos</div>`);
    uniq.forEach(u=>{
      parts.push(`<div class="alma-budget-link"><a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a></div>`);
    });
  }

  return parts.join("");
}

/* ---------- fallback normal (texto geral) ---------- */
function renderNormal(raw){
  let t = (raw||"").replace(/\r\n/g,"\n").trimEnd();

  // mantém estrutura e torna legível quando vem colado com Links/Total
  t = t.replace(/\s+(Total:)/gi, "\n$1");
  t = t.replace(/\s+(Links dos produtos:)/gi, "\n\n$1\n");
  t = t.replace(/(Links dos produtos\s*:)\s*/ig, "$1\n");
  t = t.replace(/([^\n])\s*(https?:\/\/)/g, "$1\n$2");
  t = t.replace(/\n{3,}/g, "\n\n");

  // parágrafos por blocos (sem “inventar” layout)
  const blocks = t.split(/\n{2,}/).filter(Boolean);
  const out = blocks.map(b=>{
    let html = inlineMdSafe(escapeHtml(b)).replace(/\n/g,"<br>");
    html = linkifyHtml(html);
    return `<div class="alma-p">${html}</div>`;
  });
  return out.join("");
}

/* =========================================================
   PATCH: substitui só o render de mensagens da Alma
   - Mantém as tuas sessions/localStorage/sendMsg intactos.
   - Re-renderiza tudo imediatamente.
   ========================================================= */
(function patchAlmaRenderer(){
  // Se não existir a função base de renderMsgs, não faz nada.
  if(typeof window.renderMsgs !== "function") return;

  // Guarda referência ao renderMsgs original (se quiseres voltar atrás)
  if(!window.__renderMsgsOriginal) window.__renderMsgsOriginal = window.renderMsgs;

  // Patch: cria um renderMsgs que usa formatação melhor para mensagens "alma"
  window.renderMsgs = function(){
    const s = (window.sessions||[]).find(x=>x.id===window.activeId);
    const box = byId("messages");
    if(!box) return;
    box.innerHTML = "";
    if(!s) return;

    (s.msgs||[]).forEach(m=>{
      const row = document.createElement("div");
      row.className = "msg " + m.role;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if(m.role === "user"){
        bubble.textContent = (m.content||"");
        row.appendChild(bubble);
        box.appendChild(row);
        return;
      }

      const raw = (m.content||"");
      bubble.innerHTML = looksBudget(raw) ? renderBudget(raw) : renderNormal(raw);

      const copy = document.createElement("span");
      copy.className = "copy-btn";
      copy.textContent = "copiar";
      copy.onclick = ()=>navigator.clipboard.writeText(raw);
      bubble.appendChild(copy);

      row.appendChild(bubble);
      box.appendChild(row);
    });

    box.scrollTop = box.scrollHeight;
  };

  // re-render imediato
  try{ window.renderMsgs(); }catch(_){}
})();
</script>

</body>
</html>
