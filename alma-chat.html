<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <title>Alma Chat</title>
  <style>
    :root {
      --bg:#0b0b0b;
      --fg:#f5f5f5;
      --accent:#d4a017;
      --border:#333;
    }
    body {
      margin:0;
      font-family:system-ui, sans-serif;
      background:var(--bg);
      color:var(--fg);
      display:flex;
      height:100vh;
      overflow:hidden;
    }
    .sidebar {
      width:280px;
      background:#111;
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
    }
    .header {
      position:sticky;
      top:0;
      z-index:20;
      display:flex;
      align-items:flex-end; /* alinhado pela base */
      gap:16px;
      padding:12px 16px;
      background:linear-gradient(180deg,#0b0b0b,rgba(11,11,11,.92));
      border-bottom:1px solid var(--border);
    }
    .header img {
      width:72px;  /* 3x maior */
      height:72px;
      border-radius:50%;
    }
    .header h1 {
      font-size:1.4em;
      font-weight:bold;
      margin:0;
    }
    .sessions {
      flex:1;
      overflow-y:auto;
      padding:8px;
    }
    .session {
      padding:6px 10px;
      border:1px solid var(--border);
      margin-bottom:6px;
      cursor:pointer;
      border-radius:6px;
    }
    .session:hover { background:#222; }
    .session.active { background:#333; border-color:var(--accent); }
    .session .del {
      float:right;
      color:#999;
      cursor:pointer;
      font-size:0.9em;
      margin-left:8px;
    }
    .session .del:hover { color:#f66; }
    .controls {
      padding:8px;
      border-top:1px solid var(--border);
      display:flex;
      gap:8px;
      justify-content:space-between;
    }
    .controls button {
      background:none;
      border:none;
      color:var(--fg);
      cursor:pointer;
      font-size:1em;
    }
    .controls button:hover { color:var(--accent); }
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .messages {
      flex:1;
      overflow-y:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .msg {
      padding:10px 14px;
      border-radius:8px;
      max-width:75%;
      white-space:pre-wrap;
      line-height:1.4;
      position:relative;
    }
    .msg.user {
      background:#222;
      align-self:flex-start;
    }
    .msg.alma {
      background:#333;
      align-self:flex-end;
    }
    .copy-btn {
      position:absolute;
      bottom:4px;
      right:8px;
      font-size:0.75em;
      color:#bbb;
      cursor:pointer;
    }
    .copy-btn:hover { color:var(--accent); }
    .input-bar {
      display:flex;
      border-top:1px solid var(--border);
      background:#111;
    }
    .input-bar input {
      flex:1;
      padding:12px;
      background:none;
      border:none;
      outline:none;
      color:var(--fg);
      font-size:1em;
    }
    .input-bar button {
      background:var(--accent);
      border:none;
      color:#000;
      padding:0 20px;
      cursor:pointer;
      font-size:1.2em;
    }
    .input-bar button:hover { background:#e0b323; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="header">
      <img src="/static/alma.png" alt="Alma"/>
      <h1>Alma - chat</h1>
    </div>
    <div class="sessions" id="sessions"></div>
    <div class="controls">
      <button onclick="newSession()">+</button>
      <button onclick="clearLocal()">x</button>
    </div>
  </div>
  <div class="main">
    <div class="messages" id="messages"></div>
    <div class="input-bar">
      <input id="prompt" placeholder="Escreve aqui..."/>
      <button onclick="sendMsg()">></button>
    </div>
  </div>

<script>
let sessions = JSON.parse(localStorage.getItem("alma_sessions")||"[]");
let activeId = sessions.length? sessions[0].id : null;
renderSessions();

function newSession(){
  const id="s"+Date.now();
  sessions.unshift({id,title:"Nova sessão",msgs:[]});
  activeId=id;
  saveSessions();
  renderSessions();
  renderMsgs();
}
function delSession(id){
  sessions=sessions.filter(s=>s.id!==id);
  if(activeId===id) activeId=sessions.length? sessions[0].id:null;
  saveSessions();
  renderSessions();
  renderMsgs();
}
function clearLocal(){
  if(confirm("Apagar histórico local?")){
    sessions=[];
    activeId=null;
    saveSessions();
    renderSessions();
    renderMsgs();
  }
}
function saveSessions(){ localStorage.setItem("alma_sessions",JSON.stringify(sessions)); }
function renderSessions(){
  const box=document.getElementById("sessions");
  box.innerHTML="";
  sessions.forEach(s=>{
    const div=document.createElement("div");
    div.className="session"+(s.id===activeId?" active":"");
    div.textContent=s.title;
    const del=document.createElement("span");
    del.className="del"; del.textContent="x";
    del.onclick=(ev)=>{ev.stopPropagation(); delSession(s.id);};
    div.appendChild(del);
    div.onclick=()=>{activeId=s.id; renderSessions(); renderMsgs();};
    box.appendChild(div);
  });
}
function renderMsgs(){
  const s=sessions.find(x=>x.id===activeId);
  const box=document.getElementById("messages");
  box.innerHTML="";
  if(!s) return;
  s.msgs.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg "+m.role;
    div.innerHTML=m.content
      .replace(/\*\*(.*?)\*\*/g,"<b>$1</b>")
      .replace(/__(.*?)__/g,"<u>$1</u>");
    if(m.role==="alma"){
      const copy=document.createElement("span");
      copy.className="copy-btn";
      copy.textContent="copiar";
      copy.onclick=()=>navigator.clipboard.writeText(m.content);
      div.appendChild(copy);
    }
    box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
}
async function sendMsg(){
  const inp=document.getElementById("prompt");
  const txt=inp.value.trim(); if(!txt) return;
  inp.value="";
  const s=sessions.find(x=>x.id===activeId);
  if(!s){ newSession(); return sendMsg(); }
  s.msgs.push({role:"user",content:txt});
  renderMsgs();
  const r=await fetch("/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:txt,user_id:activeId})});
  const j=await r.json();
  const ans=j.answer||JSON.stringify(j);
  s.msgs.push({role:"alma",content:ans});
  renderMsgs();
  saveSessions();
}
renderMsgs();
</script>
</body>
</html>
