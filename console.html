<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alma Data — Console RAG</title>
<style>
  /* ======= PALETA alinhada ao alma-chat (apenas estilo) ======= */
  :root{
    --bg:#0a0a0b;
    --panel:#0f0f11;
    --panel-2:#141418;
    --text:#f3f3f3;
    --muted:#cfcfd3;
    --ok:#39d98a;
    --err:#ff6b6b;
    --chip:#101217;
    --chip-br:#26262b;
    --tile-gap:16px;
    --accent:#d4a017;          /* amarelo torrado */
    --accent-700:#be8f13;
    --accent-800:#a47c12;
    --shadow: 0 1px 0 rgba(255,255,255,0.03), 0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
  }
  .container{max-width:1200px;margin:0 auto;padding:20px}

  /* ======= HEADER ======= */
  header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:14px
  }
  header .brand{
    font-weight:800;font-size:20px;letter-spacing:.2px
  }
  header .status{font-size:12px;color:var(--muted);opacity:.9}

  /* ======= RESULT PANEL (sempre no topo) ======= */
  .result{
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--chip-br);border-radius:14px;
    padding:16px; margin-bottom:16px; position:relative;
    box-shadow:var(--shadow);
  }
  .result h2{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px}
  .result pre{
    margin:0;background:var(--panel-2);border:1px solid var(--chip-br);
    color:var(--text);border-radius:10px;padding:12px;overflow:auto;max-height:38vh;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
  }
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0 0}
  .badge{
    background:var(--chip);
    border:1px solid var(--chip-br);
    border-radius:999px;
    padding:6px 12px;
    font-size:12px;color:var(--muted);
  }

  /* ======= PARAM BAR ======= */
  .param-bar{
    display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:18px
  }
  .field{display:flex;flex-direction:column;gap:6px;min-width:160px}
  label{font-size:12px;color:var(--muted)}
  input[type=text], input[type=number], textarea{
    background:#101014;border:1px solid var(--chip-br);color:var(--text);
    border-radius:10px;padding:12px 12px;outline:none;width:100%;
    transition:border-color .12s, box-shadow .12s;
  }
  input[type=text]:focus, input[type=number]:focus, textarea:focus{
    border-color:#32323a; box-shadow:0 0 0 3px rgba(212,160,23,.12);
  }
  textarea{min-height:110px;resize:vertical}

  /* ======= BUTTONS ======= */
  .btn{
    background:var(--accent);color:#121212;border:none;border-radius:12px;
    padding:11px 16px;font-weight:800;cursor:pointer;transition:.12s;
    box-shadow:0 1px 0 rgba(0,0,0,.35) inset, 0 0 0 1px rgba(0,0,0,.25);
    letter-spacing:.2px;
  }
  .btn:hover{background:var(--accent-700)}
  .btn:active{background:var(--accent-800);transform:translateY(1px)}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  /* ======= LAYOUT COMUM ======= */
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .right{margin-left:auto}
  .tiny{font-size:12px;color:var(--muted)}
  .timer{font-size:12px;color:var(--muted)}

  /* ======= TILES ======= */
  .grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:var(--tile-gap);
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }
  .tile{
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--chip-br);border-radius:14px;
    padding:16px;display:flex;flex-direction:column;gap:12px;
    box-shadow:var(--shadow);
  }
  .tile h3{margin:0 0 4px 0;font-size:15px;letter-spacing:.2px}
  .tile .res{
    background:var(--panel-2);border:1px solid var(--chip-br);border-radius:10px;
    padding:12px;min-height:46px;color:var(--muted);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
    white-space:pre-wrap;word-break:break-word
  }
  .inline{display:flex;gap:10px}
  .inline > *{flex:1}

  .chip-ok{color:var(--ok)}
  .chip-err{color:var(--err)}

  /* Progress bar */
  .progress{height:10px;background:#101014;border:1px solid var(--chip-br);border-radius:8px;overflow:hidden}
  .progress > div{height:100%;background:var(--accent);width:0%}

  /* ======= Scrollbars (WebKit) ======= */
  .result pre::-webkit-scrollbar,
  .tile .res::-webkit-scrollbar{ width:10px;height:10px; }
  .result pre::-webkit-scrollbar-thumb,
  .tile .res::-webkit-scrollbar-thumb{ background:#2a2a31;border-radius:10px; }
  .result pre::-webkit-scrollbar-track,
  .tile .res::-webkit-scrollbar-track{ background:transparent; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">Alma Data</div>
      <div class="status tiny">Versão do servidor: <span id="sv-version">—</span> &nbsp;•&nbsp; RAG: <span id="sv-rag">—</span> &nbsp;•&nbsp; Mem0: <span id="sv-mem">—</span></div>
    </header>

    <!-- RESULTADO NO TOPO -->
    <section class="result">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Resultado</h2>
        <div class="timer" id="globalTimer">⏱︎ 00:00</div>
      </div>
      <div class="badges" id="summaryBadges"></div>
      <pre id="resultBox">{}</pre>
    </section>

    <!-- PARÂMETROS EM BARRA HORIZONTAL -->
    <section class="param-bar">
      <div class="field" style="min-width:240px">
        <label>Namespace (default)</label>
        <input type="text" id="ns" placeholder="ex.: boasafra">
      </div>
      <div class="field">
        <label>max_pages</label>
        <input type="number" id="max_pages" min="1" value="500">
      </div>
      <div class="field">
        <label>deadline_s</label>
        <input type="number" id="deadline_s" min="10" value="900">
      </div>
      <div class="field">
        <label>max_depth (crawler)</label>
        <input type="number" id="max_depth" min="0" value="4">
      </div>
      <div class="right tiny">Tarefa atual: <span id="taskLabel">—</span></div>
      <button class="btn right" id="clearLogsBtn" title="Limpa o painel de resultado">Limpar resultado</button>
    </section>

    <!-- 6 TILES + 1 novo -->
    <section class="grid">

      <!-- Ingestão via Sitemap -->
      <div class="tile">
        <h3>Ingestão via Sitemap</h3>
        <div class="inline">
          <input id="sitemap_url" type="text" placeholder="https://exemplo.com/sitemap.xml">
          <button id="btnIngestSitemap" class="btn">Ingerir Sitemap</button>
        </div>
        <div class="res" id="resSitemap">{}</div>
        <div class="tiny">Sitemap muito grande? Prefere “Lista de URLs (lotes)” abaixo para ter progresso e tolerância a falhas.</div>
      </div>

      <!-- Crawler (mesmo domínio) -->
      <div class="tile">
        <h3>Crawler (mesmo domínio)</h3>
        <div class="inline">
          <input id="seed_url" type="text" placeholder="https://exemplo.com/">
          <button id="btnCrawl" class="btn">Rastrear & Ingerir</button>
        </div>
        <div class="res" id="resCrawl">{}</div>
      </div>

      <!-- Ingestão de URL individual -->
      <div class="tile">
        <h3>Ingestão de URL individual</h3>
        <input id="single_url" type="text" placeholder="https://exemplo.com/pagina/  (aceita Google Drive)">
        <button id="btnIngestURL" class="btn">Ingerir URL</button>
        <div class="res" id="resURL">{}</div>
        <div class="tiny">Dica: cola links do Google Drive (view/open/file). Convertimos automaticamente para download direto.</div>
      </div>

      <!-- Ingestão de Texto -->
      <div class="tile">
        <h3>Ingestão de Texto</h3>
        <input id="text_title" type="text" placeholder="Título do bloco">
        <textarea id="text_body" placeholder="Texto a indexar…"></textarea>
        <button id="btnIngestText" class="btn">Ingerir Texto</button>
        <div class="res" id="resText">{}</div>
      </div>

      <!-- Ingestão de PDF (URL) -->
      <div class="tile">
        <h3>Ingestão de PDF (URL)</h3>
        <input id="pdf_url" type="text" placeholder="https://…/ficheiro.pdf  (aceita Google Drive)">
        <input id="pdf_title" type="text" placeholder="Título (opcional)">
        <button id="btnIngestPDF" class="btn">Ingerir PDF</button>
        <div class="res" id="resPDF">{}</div>
        <div class="tiny">Para Google Drive, podes colar o link “view” — fazemos a conversão para download direto.</div>
      </div>

      <!-- Pesquisar (RAG) -->
      <div class="tile">
        <h3>Pesquisar (RAG)</h3>
        <input id="search_q" type="text" placeholder="ex.: diretora da Boa Safra">
        <input id="search_topk" type="number" value="6" min="1" max="50" />
        <button id="btnSearch" class="btn">Pesquisar</button>
        <div class="res" id="resSearch">{}</div>
      </div>

      <!-- NOVO: Ingestão de lista de URLs (lotes) -->
      <div class="tile">
        <h3>Ingestão de lista de URLs (lotes)</h3>
        <textarea id="bulk_urls" placeholder="Cola aqui 1 URL por linha (podes colar 1700+)"></textarea>
        <div class="row">
          <div class="field">
            <label>Concorrência</label>
            <input id="bulk_conc" type="number" min="1" max="6" value="2">
          </div>
          <div class="field">
            <label>Lote (URLs/min)</label>
            <input id="bulk_rate" type="number" min="10" max="3000" value="240">
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button id="bulk_start" class="btn">Iniciar</button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button id="bulk_stop" class="btn" disabled>Parar</button>
          </div>
        </div>
        <div class="progress"><div id="bulk_bar"></div></div>
        <div class="tiny" id="bulk_stats">—</div>
        <div class="res" id="resBulk">{}</div>
      </div>

    </section>
  </div>

<script>
(function(){
  // -------- util ----------
  const $ = sel => document.querySelector(sel);
  const resultBox = $('#resultBox');
  const badgesBox = $('#summaryBadges');
  const taskLabel = $('#taskLabel');
  const svVersion = $('#sv-version');
  const svRag = $('#sv-rag');
  const svMem = $('#sv-mem');

  let timerInterval = null;
  function startTimer(){
    const t0 = Date.now();
    const el = $('#globalTimer');
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      const s = Math.floor((Date.now()-t0)/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      el.textContent = `⏱︎ ${mm}:${ss}`;
    }, 200);
  }
  function stopTimer(){ clearInterval(timerInterval); }

  function setTask(t){ taskLabel.textContent = t || '—'; }
  function setBadges(list){
    badgesBox.innerHTML = '';
    (list||[]).forEach(txt=>{
      const b = document.createElement('div');
      b.className = 'badge';
      b.textContent = txt;
      badgesBox.appendChild(b);
    });
  }
  function printResult(obj){
    resultBox.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
  }
  function smallRes(el, obj){
    el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
  }

  // -------- status /health ----------
  async function loadHealth(){
    try{
      const r = await fetch('/health');
      const j = await r.json();
      svVersion.textContent = (j.model || '—');
      svRag.textContent = j.rag_available ? 'disponível' : 'off';
      svMem.textContent = j.mem0_enabled ? 'on' : 'off';
    }catch(e){
      svVersion.textContent = '—';
      svRag.textContent = '—';
      svMem.textContent = '—';
    }
  }
  loadHealth();

  // -------- Google Drive normalização ----------
  function normalizeGoogleDriveLink(url){
    try{
      const u = new URL(url);
      if (u.hostname !== 'drive.google.com') return url;

      if (u.pathname === '/uc' && (u.searchParams.get('id') || u.searchParams.get('export'))){
        return url;
      }
      const m = u.pathname.match(/\/file\/d\/([^/]+)/);
      if (m && m[1]) {
        const id = m[1];
        return `https://drive.google.com/uc?export=download&id=${id}`;
      }
      if (u.pathname === '/open' && u.searchParams.get('id')){
        const id = u.searchParams.get('id');
        return `https://drive.google.com/uc?export=download&id=${id}`;
      }
      return url;
    }catch(e){
      return url;
    }
  }

  // -------- params ----------
  function readCommon(){
    return {
      namespace: $('#ns').value.trim() || undefined,
      max_pages: parseInt($('#max_pages').value || '0', 10) || undefined,
      deadline_s: parseInt($('#deadline_s').value || '0', 10) || undefined,
      max_depth: parseInt($('#max_depth').value || '0', 10) || undefined,
    };
  }

  // -------- chamadas ----------
  async function postJSON(path, payload){
    const r = await fetch(path, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload || {})
    });
    return r.json();
  }

  // Ingest Sitemap
  $('#btnIngestSitemap').addEventListener('click', async ()=>{
    const sitemap_url = $('#sitemap_url').value.trim();
    if (!sitemap_url) return;
    const p = readCommon();
    setTask(`ação: ingest-sitemap   item: ${sitemap_url}`);
    setBadges([`Sitemap: ${sitemap_url}`, `namespace: ${p.namespace||'default'}`, `deadline_s: ${p.deadline_s||'—'}`, `max_pages: ${p.max_pages||'—'}`]);
    startTimer();
    $('#btnIngestSitemap').disabled = true;
    const res = await postJSON('/rag/ingest-sitemap', { sitemap_url, namespace:p.namespace, max_pages:p.max_pages, deadline_s:p.deadline_s });
    stopTimer();
    $('#btnIngestSitemap').disabled = false;
    printResult(res);
    smallRes($('#resSitemap'), res);
  });

  // Crawl
  $('#btnCrawl').addEventListener('click', async ()=>{
    const seed_url = $('#seed_url').value.trim();
    if (!seed_url) return;
    const p = readCommon();
    setTask(`ação: crawl   seed: ${seed_url}`);
    setBadges([`Seed: ${seed_url}`, `namespace: ${p.namespace||'default'}`, `deadline_s: ${p.deadline_s||'—'}`, `max_pages: ${p.max_pages||'—'}`, `max_depth: ${p.max_depth||'—'}`]);
    startTimer();
    $('#btnCrawl').disabled = true;
    const res = await postJSON('/rag/crawl', { seed_url, namespace:p.namespace, max_pages:p.max_pages, max_depth:p.max_depth, deadline_s:p.deadline_s });
    stopTimer();
    $('#btnCrawl').disabled = false;
    printResult(res);
    smallRes($('#resCrawl'), res);
  });

  // URL individual (com normalização de Drive)
  $('#btnIngestURL').addEventListener('click', async ()=>{
    let page_url = $('#single_url').value.trim();
    if (!page_url) return;
    page_url = normalizeGoogleDriveLink(page_url);
    $('#single_url').value = page_url;
    const p = readCommon();
    setTask(`ação: ingest-url   item: ${page_url}`);
    setBadges([`URL: ${page_url}`, `namespace: ${p.namespace||'default'}`]);
    startTimer();
    $('#btnIngestURL').disabled = true;
    const res = await postJSON('/rag/ingest-url', { page_url, namespace:p.namespace, deadline_s:p.deadline_s });
    stopTimer();
    $('#btnIngestURL').disabled = false;
    printResult(res);
    smallRes($('#resURL'), res);
  });

  // Texto
  $('#btnIngestText').addEventListener('click', async ()=>{
    const title = $('#text_title').value.trim();
    const text  = $('#text_body').value.trim();
    if (!title || !text) return;
    const p = readCommon();
    setTask(`ação: ingest-text   título: ${title}`);
    setBadges([`Título: ${title}`, `namespace: ${p.namespace||'default'}`]);
    startTimer();
    $('#btnIngestText').disabled = true;
    const res = await postJSON('/rag/ingest-text', { title, text, namespace:p.namespace });
    stopTimer();
    $('#btnIngestText').disabled = false;
    printResult(res);
    smallRes($('#resText'), res);
  });

  // PDF (URL) — também normaliza Drive
  $('#btnIngestPDF').addEventListener('click', async ()=>{
    let pdf_url = $('#pdf_url').value.trim();
    const title = $('#pdf_title').value.trim() || null;
    if (!pdf_url) return;
    pdf_url = normalizeGoogleDriveLink(pdf_url);
    $('#pdf_url').value = pdf_url;
    const p = readCommon();
    setTask(`ação: ingest-pdf-url   item: ${pdf_url}`);
    setBadges([`PDF: ${pdf_url}`, `namespace: ${p.namespace||'default'}`]);
    startTimer();
    $('#btnIngestPDF').disabled = true;
    const res = await postJSON('/rag/ingest-pdf-url', { pdf_url, title, namespace:p.namespace });
    stopTimer();
    $('#btnIngestPDF').disabled = false;
    printResult(res);
    smallRes($('#resPDF'), res);
  });

  // Search
  $('#btnSearch').addEventListener('click', async ()=>{
    const query = $('#search_q').value.trim();
    const top_k = parseInt($('#search_topk').value || '6', 10);
    const p = readCommon();
    if (!query) return;
    setTask(`ação: search   q: ${query}`);
    setBadges([`q: ${query}`, `namespace: ${p.namespace||'default'}`, `top_k: ${top_k}`]);
    startTimer();
    $('#btnSearch').disabled = true;
    const res = await postJSON('/rag/search', { query, namespace:p.namespace, top_k });
    stopTimer();
    $('#btnSearch').disabled = false;
    printResult(res);
    smallRes($('#resSearch'), res);
  });

  // Limpar
  $('#clearLogsBtn').addEventListener('click', ()=>{
    printResult('{}'); setBadges([]); setTask('—');
  });

  // ============ NOVO: Bulk ingest (em lotes) ============
  const bulk = {
    running: false,
    aborter: null,
    total: 0,
    done: 0,
    ok: 0,
    fail: 0
  };

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  function updateBulkUI(){
    const bar = $('#bulk_bar');
    const stats = $('#bulk_stats');
    const pct = bulk.total ? Math.round((bulk.done / bulk.total) * 100) : 0;
    bar.style.width = pct + '%';
    stats.textContent = `Progresso: ${bulk.done}/${bulk.total}  •  OK: ${bulk.ok}  •  Erros: ${bulk.fail}  •  Restantes: ${Math.max(0, bulk.total - bulk.done)}`;
  }

  async function ingestOneURL(page_url, namespace, deadline_s){
    try{
      const payload = { page_url, namespace, deadline_s };
      const r = await fetch('/rag/ingest-url', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        signal: bulk.aborter.signal
      });
      const j = await r.json().catch(()=>({ok:false, error:'json parse'}));
      return j;
    }catch(e){
      return { ok:false, error: String(e) };
    }
  }

  $('#bulk_start').addEventListener('click', async ()=>{
    const raw = $('#bulk_urls').value.split('\n').map(s=>s.trim()).filter(Boolean);
    if (raw.length === 0) return;

    // prepara URLs (normaliza Drive quando aplicável)
    const urls = raw.map(u => {
      try { return normalizeGoogleDriveLink(u); } catch { return u; }
    });

    const conc = Math.max(1, Math.min(6, parseInt($('#bulk_conc').value || '2',10)));
    const rate = Math.max(10, parseInt($('#bulk_rate').value || '240',10)); // URLs/min
    const delayPerReq = Math.floor(60000 / rate); // ms entre lançamentos
    const p = readCommon();
    setTask(`ação: bulk-ingest   ${urls.length} URLs`);
    setBadges([`Total: ${urls.length}`, `conc: ${conc}`, `rate: ${rate}/min`, `namespace: ${p.namespace||'default'}`]);

    // estado
    bulk.running = true;
    bulk.aborter = new AbortController();
    bulk.total = urls.length;
    bulk.done = 0; bulk.ok = 0; bulk.fail = 0;
    updateBulkUI();
    $('#bulk_start').disabled = true;
    $('#bulk_stop').disabled = false;
    startTimer();

    // executa com “n” workers em paralelo, espaçando arranques
    const queue = urls.slice();
    const results = [];
    async function worker(id){
      while(bulk.running && queue.length){
        const u = queue.shift();
        if (!u) break;
        const res = await ingestOneURL(u, p.namespace, p.deadline_s);
        results.push({ url:u, res });
        bulk.done += 1;
        if (res && res.ok !== false) bulk.ok += 1; else bulk.fail += 1;
        updateBulkUI();
        await sleep(delayPerReq); // controlo de taxa
      }
    }

    const workers = Array.from({length: conc}, (_,i)=>worker(i));
    await Promise.race([
      Promise.all(workers),
      new Promise((_,rej)=> bulk.aborter.signal.addEventListener('abort', ()=>rej(new Error('aborted')), {once:true}))
    ]).catch(()=>{}); // swallow abort

    stopTimer();
    $('#bulk_start').disabled = false;
    $('#bulk_stop').disabled = true;
    bulk.running = false;

    // resumo e últimos 10 resultados
    const last = results.slice(-10).map(x=>({url:x.url, ok:x.res?.ok!==false, err:x.res?.error||null}));
    smallRes($('#resBulk'), { summary:{total:bulk.total, ok:bulk.ok, fail:bulk.fail}, last10:last });
    printResult({ summary:{total:bulk.total, ok:bulk.ok, fail:bulk.fail}, sample:last });
  });

  $('#bulk_stop').addEventListener('click', ()=>{
    if (!bulk.running) return;
    bulk.running = false;
    try{ bulk.aborter?.abort(); }catch{}
    $('#bulk_start').disabled = false;
    $('#bulk_stop').disabled = true;
    setTask('—');
  });

})();
</script>
</body>
</html>
