<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Alma — Console RAG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --ink:#e6e6e6; --muted:#9aa0a6; --accent:#5ac8fa; }
    html,body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    h1{font-size:20px;margin:24px 0 12px}
    h2{font-size:16px;margin:18px 0 8px;color:var(--accent)}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid #23262d}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,textarea,select{width:100%;background:#0f1116;border:1px solid #2a2f39;color:var(--ink);
      border-radius:10px;padding:10px 12px;outline:none}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    button{background:var(--accent);border:0;color:#00131f;font-weight:700;border-radius:10px;
      padding:10px 14px;margin-top:10px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    pre{white-space:pre-wrap;background:#0f1116;border:1px solid #2a2f39;color:#cfe7ff;border-radius:10px;padding:12px}
    .log{font-size:12px;color:#b7c1cc}
    .pill{display:inline-block;border:1px solid #2a2f39;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alma • Console RAG</h1>
    <div class="grid">

      <!-- INGEST VIA SITEMAP -->
      <div class="card">
        <h2>Ingerir via Sitemap</h2>
        <label>Sitemap URL</label>
        <input id="sitemap_url" placeholder="https://exemplo.com/sitemap.xml" />
        <div class="row3">
          <div>
            <label>Namespace</label>
            <input id="sitemap_ns" placeholder="default" />
          </div>
          <div>
            <label>Max pages</label>
            <input id="sitemap_max" type="number" min="1" value="500" />
          </div>
          <div>
            <label>Deadline (s)</label>
            <input id="sitemap_deadline" type="number" min="30" value="600" />
          </div>
        </div>
        <button id="btn_sitemap">Ingerir Sitemap</button>
        <div class="log" id="log_sitemap"></div>
        <pre id="out_sitemap"></pre>
      </div>

      <!-- CRAWLER -->
      <div class="card">
        <h2>Crawler (seed URL)</h2>
        <label>Seed URL</label>
        <input id="crawl_seed" placeholder="https://exemplo.com/" />
        <div class="row3">
          <div>
            <label>Namespace</label>
            <input id="crawl_ns" placeholder="default" />
          </div>
          <div>
            <label>Max pages</label>
            <input id="crawl_max" type="number" min="1" value="400" />
          </div>
          <div>
            <label>Max depth</label>
            <input id="crawl_depth" type="number" min="1" value="3" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Deadline (s)</label>
            <input id="crawl_deadline" type="number" min="30" value="600" />
          </div>
          <div>
            <label>Verbose (debug UI)</label>
            <select id="crawl_verbose">
              <option value="false" selected>Não</option>
              <option value="true">Sim</option>
            </select>
          </div>
        </div>
        <button id="btn_crawl">Crawl & Ingest</button>
        <div class="log" id="log_crawl"></div>
        <pre id="out_crawl"></pre>
      </div>

      <!-- INGEST URL INDIVIDUAL -->
      <div class="card">
        <h2>Ingerir URL individual</h2>
        <label>Page URL</label>
        <input id="url_one" placeholder="https://exemplo.com/pagina/" />
        <div class="row">
          <div>
            <label>Namespace</label>
            <input id="url_one_ns" placeholder="default" />
          </div>
          <div>
            <label>Deadline (s)</label>
            <input id="url_one_deadline" type="number" min="30" value="120" />
          </div>
        </div>
        <button id="btn_url_one">Ingerir URL</button>
        <div class="log" id="log_url_one"></div>
        <pre id="out_url_one"></pre>
      </div>

      <!-- INGEST TEXTO -->
      <div class="card">
        <h2>Ingerir Texto</h2>
        <label>Título</label>
        <input id="txt_title" placeholder="Nota / Documento" />
        <label>Texto</label>
        <textarea id="txt_body" placeholder="Texto para indexar…"></textarea>
        <label>Namespace</label>
        <input id="txt_ns" placeholder="default" />
        <button id="btn_txt">Ingerir Texto</button>
        <div class="log" id="log_txt"></div>
        <pre id="out_txt"></pre>
      </div>

      <!-- INGEST PDF -->
      <div class="card">
        <h2>Ingerir PDF (URL)</h2>
        <label>PDF URL</label>
        <input id="pdf_url" placeholder="https://exemplo.com/ficheiro.pdf" />
        <div class="row">
          <div>
            <label>Título (opcional)</label>
            <input id="pdf_title" />
          </div>
          <div>
            <label>Namespace</label>
            <input id="pdf_ns" placeholder="default" />
          </div>
        </div>
        <button id="btn_pdf">Ingerir PDF</button>
        <div class="log" id="log_pdf"></div>
        <pre id="out_pdf"></pre>
      </div>

      <!-- SEARCH -->
      <div class="card">
        <h2>Pesquisar</h2>
        <label>Query</label>
        <input id="q" placeholder="ex.: diretora da boa safra" />
        <div class="row">
          <div>
            <label>Namespace</label>
            <input id="q_ns" placeholder="default" />
          </div>
          <div>
            <label>Top K</label>
            <input id="q_topk" type="number" min="1" value="6" />
          </div>
        </div>
        <button id="btn_search">Pesquisar</button>
        <div class="log" id="log_search"></div>
        <pre id="out_search"></pre>
      </div>

    </div>

    <div class="card" style="margin-top:16px">
      <div class="flex">
        <span class="pill">/rag/ingest-sitemap</span>
        <span class="pill">/rag/crawl</span>
        <span class="pill">/rag/ingest-url</span>
        <span class="pill">/rag/ingest-text</span>
        <span class="pill">/rag/ingest-pdf-url</span>
        <span class="pill">/rag/search</span>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const api = (path) => path; // mesmo host

    function show(elLog, elOut, head, obj) {
      const now = new Date().toLocaleTimeString();
      elLog.textContent = `[${now}] ${head}`;
      elOut.textContent = JSON.stringify(obj, null, 2);
    }
    function disable(btn, on) { btn.disabled = on; btn.textContent = on ? 'A processar…' : btn.dataset.label; }

    // ------- Sitemap -------
    (function(){
      const btn = $("btn_sitemap");
      btn.dataset.label = "Ingerir Sitemap";
      btn.addEventListener("click", async () => {
        disable(btn, true);
        const body = {
          sitemap_url: $("sitemap_url").value.trim(),
          namespace: $("sitemap_ns").value.trim() || "default",
          max_pages: Number($("sitemap_max").value || 0) || undefined,
          deadline_s: Number($("sitemap_deadline").value || 0) || undefined
        };
        try {
          const r = await fetch(api("/rag/ingest-sitemap"), {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
          const j = await r.json();
          show($("log_sitemap"), $("out_sitemap"), `Resumo: ok=${j.ok} pages_ingested=${j.pages_ingested} domain=-`, j);
        } catch (e) {
          show($("log_sitemap"), $("out_sitemap"), "Erro a chamar /rag/ingest-sitemap", {error:String(e)});
        } finally { disable(btn, false); }
      });
    })();

    // ------- Crawl -------
    (function(){
      const btn = $("btn_crawl");
      btn.dataset.label = "Crawl & Ingest";
      btn.addEventListener("click", async () => {
        disable(btn, true);
        const body = {
          seed_url: $("crawl_seed").value.trim(),
          namespace: $("crawl_ns").value.trim() || "default",
          max_pages: Number($("crawl_max").value || 0) || undefined,
          max_depth: Number($("crawl_depth").value || 0) || undefined,
          deadline_s: Number($("crawl_deadline").value || 0) || undefined,
          verbose: $("crawl_verbose").value === "true"
        };
        try {
          const r = await fetch(api("/rag/crawl"), {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
          const j = await r.json();
          const v = j.visited ?? "–";
          show($("log_crawl"), $("out_crawl"), `Resumo: ok=${j.ok} visited=${v} namespace=${body.namespace}`, j);
        } catch (e) {
          show($("log_crawl"), $("out_crawl"), "Erro a chamar /rag/crawl", {error:String(e)});
        } finally { disable(btn, false); }
      });
    })();

    // ------- URL individual -------
    (function(){
      const btn = $("btn_url_one");
      btn.dataset.label = "Ingerir URL";
      btn.addEventListener("click", async () => {
        disable(btn, true);
        const body = {
          page_url: $("url_one").value.trim(),
          namespace: $("url_one_ns").value.trim() || "default",
          deadline_s: Number($("url_one_deadline").value || 0) || undefined,
        };
        try {
          const r = await fetch(api("/rag/ingest-url"), {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
          const j = await r.json();
          show($("log_url_one"), $("out_url_one"), `URL: ${body.page_url}`, j);
        } catch (e) {
          show($("log_url_one"), $("out_url_one"), "Erro a chamar /rag/ingest-url", {error:String(e)});
        } finally { disable(btn, false); }
      });
    })();

    // ------- Texto -------
    (function(){
      const btn = $("btn_txt");
      btn.dataset.label = "Ingerir Texto";
      btn.addEventListener("click", async () => {
        disable(btn, true);
        const body = {
          title: $("txt_title").value.trim(),
          text: $("txt_body").value.trim(),
          namespace: $("txt_ns").value.trim() || "default",
        };
        try {
          const r = await fetch(api("/rag/ingest-text"), {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
          show($("log_txt"), $("out_txt"), "Ingest texto", await r.json());
        } catch (e) {
          show($("log_txt"), $("out_txt"), "Erro a chamar /rag/ingest-text", {error:String(e)});
        } finally { disable(btn, false); }
      });
    })();

    // ------- PDF -------
    (function(){
      const btn = $("btn_pdf");
      btn.dataset.label = "Ingerir PDF";
      btn.addEventListener("click", async () => {
        disable(btn, true);
        const body = {
          pdf_url: $("pdf_url").value.trim(),
          title: $("pdf_title").value.trim() || undefined,
          namespace: $("pdf_ns").value.trim() || "default",
        };
        try {
          const r = await fetch(api("/rag/ingest-pdf-url"), {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
          show($("log_pdf"), $("out_pdf"), "Ingest PDF", await r.json());
        } catch (e) {
          show($("log_pdf"), $("out_pdf"), "Erro a chamar /rag/ingest-pdf-url", {error:String(e)});
        } finally { disable(btn, false); }
      });
    })();

    // ------- Search -------
    (function(){
      const btn = $("btn_search");
      btn.dataset.label = "Pesquisar";
      btn.addEventListener("click", async () => {
        disable(btn, true);
        const q = encodeURIComponent($("q").value.trim());
        const ns = encodeURIComponent(($("q_ns").value.trim() || ""));
        const topk = Number($("q_topk").value || 6);
        const qs = `/rag/search?q=${q}&namespace=${ns}&top_k=${topk}`;
        try {
          const r = await fetch(api(qs));
          show($("log_search"), $("out_search"), "Pesquisa", await r.json());
        } catch (e) {
          show($("log_search"), $("out_search"), "Erro a chamar /rag/search", {error:String(e)});
        } finally { disable(btn, false); }
      });
    })();
  </script>
</body>
</html>
