<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alma Data — Console RAG</title>
<style>
  :root{
    --bg:#0f1115;
    --panel:#141820;
    --panel-2:#11151c;
    --text:#e8ecf2;
    --muted:#9aa7b3;
    --ok:#39d98a;
    --err:#ff6b6b;
    --chip:#1b2230;
    --chip-br:#243045;
    --tile-gap:16px;
    --accent:#c79300;          /* amarelo torrado */
    --accent-700:#a67a00;
    --accent-800:#8a6700;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
  }
  .container{max-width:1200px;margin:0 auto;padding:20px}
  header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:14px
  }
  header .brand{font-weight:700;font-size:20px}
  header .status{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}

  /* RESULT PANEL (sempre no topo) */
  .result{
    background:var(--panel);border:1px solid var(--chip-br);border-radius:10px;
    padding:14px; margin-bottom:14px; position:relative;
  }
  .result h2{margin:0 0 8px 0;font-size:16px}
  .result pre{
    margin:0;background:var(--panel-2);border:1px solid var(--chip-br);
    color:var(--text);border-radius:8px;padding:10px;overflow:auto;max-height:38vh
  }
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0 0}
  .badge{
    background:var(--chip);border:1px solid var(--chip-br);border-radius:999px;
    padding:4px 10px;font-size:12px;color:var(--muted);
  }

  /* PARAM BAR */
  .param-bar{
    display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:16px
  }
  .field{display:flex;flex-direction:column;gap:6px;min-width:160px}
  label{font-size:12px;color:var(--muted)}
  input[type=text], input[type=number], textarea{
    background:var(--panel);border:1px solid var(--chip-br);color:var(--text);
    border-radius:8px;padding:10px 12px;outline:none;width:100%;
  }
  textarea{min-height:110px;resize:vertical}

  /* BUTTONS */
  .btn{
    background:var(--accent);color:#121212;border:none;border-radius:10px;
    padding:10px 14px;font-weight:700;cursor:pointer;transition:.12s;
    box-shadow:0 1px 0 #000 inset, 0 0 0 1px rgba(0,0,0,.15);
  }
  .btn:hover{background:var(--accent-700)}
  .btn:active{background:var(--accent-800);transform:translateY(1px)}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  /* TILES */
  .grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:var(--tile-gap);
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }
  .tile{
    background:var(--panel);border:1px solid var(--chip-br);border-radius:12px;
    padding:14px;display:flex;flex-direction:column;gap:12px
  }
  .tile h3{margin:0 0 2px 0;font-size:15px}
  .tile .res{
    background:var(--panel-2);border:1px solid var(--chip-br);border-radius:8px;
    padding:10px;min-height:44px;color:var(--muted);font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    white-space:pre-wrap;word-break:break-word
  }
  .inline{display:flex;gap:10px}
  .inline > *{flex:1}
  .tiny{font-size:12px;color:var(--muted)}
  .right{margin-left:auto}
  .timer{font-size:12px;color:var(--muted)}
  .chip-ok{color:var(--ok)}
  .chip-err{color:var(--err)}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">Alma Data</div>
      <div class="status tiny">Versão do servidor: <span id="sv-version">—</span> &nbsp;•&nbsp; RAG: <span id="sv-rag">—</span> &nbsp;•&nbsp; Mem0: <span id="sv-mem">—</span></div>
    </header>

    <!-- RESULTADO NO TOPO -->
    <section class="result">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Resultado</h2>
        <div class="timer" id="globalTimer">⏱︎ 00:00</div>
      </div>
      <div class="badges" id="summaryBadges"></div>
      <pre id="resultBox">{}</pre>
    </section>

    <!-- PARÂMETROS EM BARRA HORIZONTAL -->
    <section class="param-bar">
      <div class="field" style="min-width:240px">
        <label>Namespace (default)</label>
        <input type="text" id="ns" placeholder="ex.: boasafra">
      </div>
      <div class="field">
        <label>max_pages</label>
        <input type="number" id="max_pages" min="1" value="500">
      </div>
      <div class="field">
        <label>deadline_s</label>
        <input type="number" id="deadline_s" min="10" value="900">
      </div>
      <div class="field">
        <label>max_depth (crawler)</label>
        <input type="number" id="max_depth" min="0" value="4">
      </div>
      <div class="right tiny">Tarefa atual: <span id="taskLabel">—</span></div>
      <button class="btn right" id="clearLogsBtn" title="Limpa o painel de resultado">Limpar resultado</button>
    </section>

    <!-- 6 TILES -->
    <section class="grid">

      <!-- Ingestão via Sitemap -->
      <div class="tile">
        <h3>Ingestão via Sitemap</h3>
        <div class="inline">
          <input id="sitemap_url" type="text" placeholder="https://exemplo.com/sitemap.xml">
          <button id="btnIngestSitemap" class="btn">Ingerir Sitemap</button>
        </div>
        <div class="res" id="resSitemap">{}</div>
      </div>

      <!-- Crawler (mesmo domínio) -->
      <div class="tile">
        <h3>Crawler (mesmo domínio)</h3>
        <div class="inline">
          <input id="seed_url" type="text" placeholder="https://exemplo.com/">
          <button id="btnCrawl" class="btn">Rastrear & Ingerir</button>
        </div>
        <div class="res" id="resCrawl">{}</div>
      </div>

      <!-- Ingestão de URL individual -->
      <div class="tile">
        <h3>Ingestão de URL individual</h3>
        <input id="single_url" type="text" placeholder="https://exemplo.com/pagina/  (aceita Google Drive)">
        <button id="btnIngestURL" class="btn">Ingerir URL</button>
        <div class="res" id="resURL">{}</div>
        <div class="tiny">Dica: cola links do Google Drive (view/open/file). Convertimos automaticamente para download direto.</div>
      </div>

      <!-- Ingestão de Texto -->
      <div class="tile">
        <h3>Ingestão de Texto</h3>
        <input id="text_title" type="text" placeholder="Título do bloco">
        <textarea id="text_body" placeholder="Texto a indexar…"></textarea>
        <button id="btnIngestText" class="btn">Ingerir Texto</button>
        <div class="res" id="resText">{}</div>
      </div>

      <!-- Ingestão de PDF (URL) -->
      <div class="tile">
        <h3>Ingestão de PDF (URL)</h3>
        <input id="pdf_url" type="text" placeholder="https://…/ficheiro.pdf  (aceita Google Drive)">
        <input id="pdf_title" type="text" placeholder="Título (opcional)">
        <button id="btnIngestPDF" class="btn">Ingerir PDF</button>
        <div class="res" id="resPDF">{}</div>
        <div class="tiny">Para Google Drive, podes colar o link “view” — fazemos a conversão para download direto.</div>
      </div>

      <!-- Pesquisar (RAG) -->
      <div class="tile">
        <h3>Pesquisar (RAG)</h3>
        <input id="search_q" type="text" placeholder="ex.: diretora da Boa Safra">
        <input id="search_topk" type="number" value="6" min="1" max="50" />
        <button id="btnSearch" class="btn">Pesquisar</button>
        <div class="res" id="resSearch">{}</div>
      </div>

    </section>
  </div>

<script>
(function(){
  // -------- util ----------
  const $ = sel => document.querySelector(sel);
  const resultBox = $('#resultBox');
  const badgesBox = $('#summaryBadges');
  const taskLabel = $('#taskLabel');
  const svVersion = $('#sv-version');
  const svRag = $('#sv-rag');
  const svMem = $('#sv-mem');

  let timerInterval = null;
  function startTimer(){
    const t0 = Date.now();
    const el = $('#globalTimer');
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      const s = Math.floor((Date.now()-t0)/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      el.textContent = `⏱︎ ${mm}:${ss}`;
    }, 200);
  }
  function stopTimer(){ clearInterval(timerInterval); }

  function setTask(t){ taskLabel.textContent = t || '—'; }
  function setBadges(list){
    badgesBox.innerHTML = '';
    (list||[]).forEach(txt=>{
      const b = document.createElement('div');
      b.className = 'badge';
      b.textContent = txt;
      badgesBox.appendChild(b);
    });
  }
  function printResult(obj){
    resultBox.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
  }
  function smallRes(el, obj){
    el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
  }

  // -------- status /health ----------
  async function loadHealth(){
    try{
      const r = await fetch('/health');
      const j = await r.json();
      svVersion.textContent = (j.model || '—');
      svRag.textContent = j.rag_available ? 'disponível' : 'off';
      svMem.textContent = j.mem0_enabled ? 'on' : 'off';
    }catch(e){
      svVersion.textContent = '—';
      svRag.textContent = '—';
      svMem.textContent = '—';
    }
  }
  loadHealth();

  // -------- Google Drive normalização ----------
  // Aceita formatos:
  // - https://drive.google.com/file/d/<ID>/view?...
  // - https://drive.google.com/open?id=<ID>
  // - https://drive.google.com/uc?export=download&id=<ID>  (já é direto)
  function normalizeGoogleDriveLink(url){
    try{
      const u = new URL(url);
      if (u.hostname !== 'drive.google.com') return url;

      // já direto
      if (u.pathname === '/uc' && (u.searchParams.get('id') || u.searchParams.get('export'))){
        return url;
      }

      // /file/d/<id>/...
      const m = u.pathname.match(/\/file\/d\/([^/]+)/);
      if (m && m[1]) {
        const id = m[1];
        return `https://drive.google.com/uc?export=download&id=${id}`;
      }

      // /open?id=...
      if (u.pathname === '/open' && u.searchParams.get('id')){
        const id = u.searchParams.get('id');
        return `https://drive.google.com/uc?export=download&id=${id}`;
      }

      // fallback: retorna original
      return url;
    }catch(e){
      return url;
    }
  }

  // -------- params ----------
  function readCommon(){
    return {
      namespace: $('#ns').value.trim() || undefined,
      max_pages: parseInt($('#max_pages').value || '0', 10) || undefined,
      deadline_s: parseInt($('#deadline_s').value || '0', 10) || undefined,
      max_depth: parseInt($('#max_depth').value || '0', 10) || undefined,
    };
  }

  // -------- chamadas ----------
  async function postJSON(path, payload){
    const r = await fetch(path, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload || {})
    });
    return r.json();
  }

  // Ingest Sitemap
  $('#btnIngestSitemap').addEventListener('click', async ()=>{
    const sitemap_url = $('#sitemap_url').value.trim();
    if (!sitemap_url) return;
    const p = readCommon();
    setTask(`ação: ingest-sitemap   item: ${sitemap_url}`);
    setBadges([`Sitemap: ${sitemap_url}`, `namespace: ${p.namespace||'default'}`, `deadline_s: ${p.deadline_s||'—'}`, `max_pages: ${p.max_pages||'—'}`]);
    startTimer();
    $('#btnIngestSitemap').disabled = true;
    const res = await postJSON('/rag/ingest-sitemap', { sitemap_url, namespace:p.namespace, max_pages:p.max_pages, deadline_s:p.deadline_s });
    stopTimer();
    $('#btnIngestSitemap').disabled = false;
    printResult(res);
    smallRes($('#resSitemap'), res);
  });

  // Crawl
  $('#btnCrawl').addEventListener('click', async ()=>{
    const seed_url = $('#seed_url').value.trim();
    if (!seed_url) return;
    const p = readCommon();
    setTask(`ação: crawl   seed: ${seed_url}`);
    setBadges([`Seed: ${seed_url}`, `namespace: ${p.namespace||'default'}`, `deadline_s: ${p.deadline_s||'—'}`, `max_pages: ${p.max_pages||'—'}`, `max_depth: ${p.max_depth||'—'}`]);
    startTimer();
    $('#btnCrawl').disabled = true;
    const res = await postJSON('/rag/crawl', { seed_url, namespace:p.namespace, max_pages:p.max_pages, max_depth:p.max_depth, deadline_s:p.deadline_s });
    stopTimer();
    $('#btnCrawl').disabled = false;
    printResult(res);
    smallRes($('#resCrawl'), res);
  });

  // URL individual (com normalização de Drive)
  $('#btnIngestURL').addEventListener('click', async ()=>{
    let page_url = $('#single_url').value.trim();
    if (!page_url) return;
    page_url = normalizeGoogleDriveLink(page_url);
    $('#single_url').value = page_url; // mostra conversão
    const p = readCommon();
    setTask(`ação: ingest-url   item: ${page_url}`);
    setBadges([`URL: ${page_url}`, `namespace: ${p.namespace||'default'}`]);
    startTimer();
    $('#btnIngestURL').disabled = true;
    const res = await postJSON('/rag/ingest-url', { page_url, namespace:p.namespace, deadline_s:p.deadline_s });
    stopTimer();
    $('#btnIngestURL').disabled = false;
    printResult(res);
    smallRes($('#resURL'), res);
  });

  // Texto
  $('#btnIngestText').addEventListener('click', async ()=>{
    const title = $('#text_title').value.trim();
    const text  = $('#text_body').value.trim();
    if (!title || !text) return;
    const p = readCommon();
    setTask(`ação: ingest-text   título: ${title}`);
    setBadges([`Título: ${title}`, `namespace: ${p.namespace||'default'}`]);
    startTimer();
    $('#btnIngestText').disabled = true;
    const res = await postJSON('/rag/ingest-text', { title, text, namespace:p.namespace });
    stopTimer();
    $('#btnIngestText').disabled = false;
    printResult(res);
    smallRes($('#resText'), res);
  });

  // PDF (URL) — também normaliza Drive
  $('#btnIngestPDF').addEventListener('click', async ()=>{
    let pdf_url = $('#pdf_url').value.trim();
    const title = $('#pdf_title').value.trim() || null;
    if (!pdf_url) return;
    pdf_url = normalizeGoogleDriveLink(pdf_url);
    $('#pdf_url').value = pdf_url;
    const p = readCommon();
    setTask(`ação: ingest-pdf-url   item: ${pdf_url}`);
    setBadges([`PDF: ${pdf_url}`, `namespace: ${p.namespace||'default'}`]);
    startTimer();
    $('#btnIngestPDF').disabled = true;
    const res = await postJSON('/rag/ingest-pdf-url', { pdf_url, title, namespace:p.namespace });
    stopTimer();
    $('#btnIngestPDF').disabled = false;
    printResult(res);
    smallRes($('#resPDF'), res);
  });

  // Search
  $('#btnSearch').addEventListener('click', async ()=>{
    const query = $('#search_q').value.trim();
    const top_k = parseInt($('#search_topk').value || '6', 10);
    const p = readCommon();
    if (!query) return;
    setTask(`ação: search   q: ${query}`);
    setBadges([`q: ${query}`, `namespace: ${p.namespace||'default'}`, `top_k: ${top_k}`]);
    startTimer();
    $('#btnSearch').disabled = true;
    const res = await postJSON('/rag/search', { query, namespace:p.namespace, top_k });
    stopTimer();
    $('#btnSearch').disabled = false;
    printResult(res);
    smallRes($('#resSearch'), res);
  });

  // Limpar
  $('#clearLogsBtn').addEventListener('click', ()=>{
    printResult('{}'); setBadges([]); setTask('—');
  });

})();
</script>
</body>
</html>
