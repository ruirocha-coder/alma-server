<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alma Data ‚Äî Console RAG</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#0f0f11; --panel-2:#141418;
    --text:#f3f3f3; --muted:#cfcfd3;
    --ok:#39d98a; --err:#ff6b6b;
    --chip:#101217; --chip-br:#26262b;
    --tile-gap:16px; --accent:#d4a017; --accent-700:#be8f13; --accent-800:#a47c12;
    --shadow: 0 1px 0 rgba(255,255,255,0.03), 0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans"}
  .container{max-width:1200px;margin:0 auto;padding:20px}

  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  header .brand{font-weight:800;font-size:20px;letter-spacing:.2px}
  header .status{font-size:12px;color:var(--muted);opacity:.9}

  .result{background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--chip-br);border-radius:14px;padding:16px;margin-bottom:16px;position:relative;box-shadow:var(--shadow)}
  .result h2{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px}
  .result pre{margin:0;background:var(--panel-2);border:1px solid var(--chip-br);
    color:var(--text);border-radius:10px;padding:12px;overflow:auto;max-height:38vh;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}

  .badges{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0 0}
  .badge{background:var(--chip);border:1px solid var(--chip-br);border-radius:999px;padding:6px 12px;font-size:12px;color:var(--muted)}

  .param-bar{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:18px}
  .field{display:flex;flex-direction:column;gap:6px;min-width:160px}
  label{font-size:12px;color:var(--muted)}
  input[type=text], input[type=number], textarea{
    background:#101014;border:1px solid var(--chip-br);color:var(--text);
    border-radius:10px;padding:12px;outline:none;width:100%;
    transition:border-color .12s, box-shadow .12s
  }
  input[type=text]:focus, input[type=number]:focus, textarea:focus{
    border-color:#32323a; box-shadow:0 0 0 3px rgba(212,160,23,.12)
  }
  textarea{min-height:110px;resize:vertical}

  .btn{background:var(--accent);color:#121212;border:none;border-radius:12px;
    padding:11px 16px;font-weight:800;cursor:pointer;transition:.12s;
    box-shadow:0 1px 0 rgba(0,0,0,.35) inset, 0 0 0 1px rgba(0,0,0,.25);letter-spacing:.2px}
  .btn:hover{background:var(--accent-700)} .btn:active{background:var(--accent-800);transform:translateY(1px)}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  .row{display:flex;gap:12px;flex-wrap:wrap}
  .right{margin-left:auto}
  .tiny{font-size:12px;color:var(--muted)}
  .timer{font-size:12px;color:var(--muted)}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--tile-gap)}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .tile{background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--chip-br);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:12px;box-shadow:var(--shadow)}
  .tile h3{margin:0 0 4px 0;font-size:15px;letter-spacing:.2px}
  .tile .res{background:var(--panel-2);border:1px solid var(--chip-br);border-radius:10px;
    padding:12px;min-height:46px;color:var(--muted);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;white-space:pre-wrap;word-break:break-word}
  .inline{display:flex;gap:10px} .inline > *{flex:1}

  .progress{height:10px;border-radius:999px;background:#1b1b1f;border:1px solid #2a2a31;overflow:hidden}
  .progress > div{height:100%;width:0;background:var(--accent);transition:width .15s ease}

  .list{background:var(--panel-2);border:1px solid var(--chip-br);border-radius:10px;padding:10px;max-height:220px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .ok{color:var(--ok)} .err{color:var(--err)}

  /* ------- Cat√°logo (Editor grande) ------- */
  .catalog-editor{margin-top:26px;background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--chip-br);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .catalog-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .catalog-toolbar .right{margin-left:auto}
  .catalog-editor table{width:100%;border-collapse:collapse;font-size:13px;min-width:1100px}
  .catalog-editor th,.catalog-editor td{border-bottom:1px solid #2a2a31;padding:8px 6px;vertical-align:top}
  .catalog-editor thead th{position:sticky;top:0;background:#111217;z-index:1}
  .catalog-editor td a{color:#fff;text-decoration:underline}
  .catalog-editor input[type=text], .catalog-editor textarea, .catalog-editor input[type=number]{
    background:#0f1014;border:1px solid #2a2a31;border-radius:8px; padding:8px;color:var(--text);width:100%}
  .catalog-editor textarea{min-height:70px;resize:vertical}
  .badge-changed{display:inline-block;background:#1f2531;border:1px solid #2d3a52;color:#9fc3ff;
    padding:3px 8px;border-radius:999px;font-size:11px;margin-left:8px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">Alma Data</div>
      <div class="status tiny">Vers√£o do servidor: <span id="sv-version">‚Äî</span> ‚Ä¢ RAG: <span id="sv-rag">‚Äî</span> ‚Ä¢ Mem0: <span id="sv-mem">‚Äî</span></div>
    </header>

    <!-- RESULTADO NO TOPO -->
    <section class="result">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Resultado</h2><div class="timer" id="globalTimer">‚è±Ô∏é 00:00</div>
      </div>
      <div class="badges" id="summaryBadges"></div>
      <pre id="resultBox">{}</pre>
    </section>

    <!-- PAR√ÇMETROS -->
    <section class="param-bar">
      <div class="field" style="min-width:240px">
        <label>Namespace (default)</label>
        <input type="text" id="ns" placeholder="ex.: boasafra">
      </div>
      <div class="field">
        <label>max_pages</label>
        <input type="number" id="max_pages" min="1" value="500">
      </div>
      <div class="field">
        <label>deadline_s</label>
        <input type="number" id="deadline_s" min="10" value="900">
      </div>
      <div class="field">
        <label>max_depth (crawler)</label>
        <input type="number" id="max_depth" min="0" value="4">
      </div>
      <div class="right tiny">Tarefa atual: <span id="taskLabel">‚Äî</span></div>
      <button class="btn right" id="clearLogsBtn">Limpar resultado</button>
    </section>

    <!-- TILES -->
    <section class="grid">

      <!-- Ingest√£o via Sitemap -->
      <div class="tile">
        <h3>Ingest√£o via Sitemap</h3>
        <div class="inline">
          <input id="sitemap_url" type="text" placeholder="https://exemplo.com/sitemap.xml">
          <button id="btnIngestSitemap" class="btn">Ingerir Sitemap</button>
        </div>
        <div class="res" id="resSitemap">{}</div>
      </div>

      <!-- Crawler (mesmo dom√≠nio) -->
      <div class="tile">
        <h3>Crawler (mesmo dom√≠nio)</h3>
        <div class="inline">
          <input id="seed_url" type="text" placeholder="https://exemplo.com/">
          <button id="btnCrawl" class="btn">Rastrear & Ingerir</button>
        </div>
        <div class="res" id="resCrawl">{}</div>
      </div>

      <!-- Ingest√£o de URL individual -->
      <div class="tile">
        <h3>Ingest√£o de URL individual</h3>
        <input id="single_url" type="text" placeholder="https://exemplo.com/pagina/  (aceita Google Drive)">
        <button id="btnIngestURL" class="btn">Ingerir URL</button>
        <div class="res" id="resURL">{}</div>
        <div class="tiny">Dica: cola links do Google Drive (view/open/file). Convertimos automaticamente para download direto.</div>
      </div>

      <!-- Ingest√£o de Texto -->
      <div class="tile">
        <h3>Ingest√£o de Texto</h3>
        <input id="text_title" type="text" placeholder="T√≠tulo do bloco">
        <textarea id="text_body" placeholder="Texto a indexar‚Ä¶"></textarea>
        <button id="btnIngestText" class="btn">Ingerir Texto</button>
        <div class="res" id="resText">{}</div>
      </div>

      <!-- Ingest√£o de PDF (URL) -->
      <div class="tile">
        <h3>Ingest√£o de PDF (URL)</h3>
        <input id="pdf_url" type="text" placeholder="https://‚Ä¶/ficheiro.pdf  (aceita Google Drive)">
        <input id="pdf_title" type="text" placeholder="T√≠tulo (opcional)">
        <button id="btnIngestPDF" class="btn">Ingerir PDF</button>
        <div class="res" id="resPDF">{}</div>
        <div class="tiny">Para Google Drive, podes colar o link ‚Äúview‚Äù ‚Äî fazemos a convers√£o para download direto.</div>
      </div>

      <!-- Pesquisar (RAG) -->
      <div class="tile">
        <h3>Pesquisar (RAG)</h3>
        <input id="search_q" type="text" placeholder="ex.: diretora da Boa Safra">
        <input id="search_topk" type="number" value="6" min="1" max="50" />
        <button id="btnSearch" class="btn">Pesquisar</button>
        <div class="res" id="resSearch">{}</div>
      </div>

      <!-- Extrair URLs do Sitemap (com fallback) -->
      <div class="tile">
        <h3>Extrair URLs do Sitemap</h3>
        <div class="inline">
          <input id="sitemap_extract_url" type="text" placeholder="https://exemplo.com/sitemap.xml">
          <button id="btnExtractSitemap" class="btn">Extrair URLs</button>
        </div>
        <div class="res" id="resExtract">‚Äî</div>
        <textarea id="extractOutput" placeholder="URLs extra√≠das aparecer√£o aqui (uma por linha)‚Ä¶" style="min-height:160px"></textarea>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button id="btnCopyExtract" class="btn" disabled>Copiar tudo</button>
        </div>
        <div class="tiny">Tenta primeiro no servidor. Se falhar, cai para extra√ß√£o no cliente (pode falhar por CORS).</div>
      </div>

      <!-- Ingerir em lote (lista de URLs) -->
      <div class="tile">
        <h3>Ingerir em lote (lista de URLs)</h3>
        <textarea id="batchUrls" placeholder="Uma URL por linha (tamb√©m aceita separado por v√≠rgulas ou espa√ßos)‚Ä¶"></textarea>
        <div class="inline">
          <input id="batchNamespace" type="text" placeholder="namespace (opcional, sen√£o usa o da barra)">
          <input id="batchDeadline" type="number" value="900" min="10" placeholder="deadline_s">
          <input id="batchConcurrency" type="number" value="3" min="1" max="10" placeholder="concorr√™ncia">
        </div>
        <div class="progress"><div id="batchBar"></div></div>
        <div class="tiny" id="batchStats">0/0 ‚Ä¢ OK: 0 ‚Ä¢ Falhas: 0</div>
        <div class="list" id="batchList"></div>
        <div class="row" style="justify-content:flex-end">
          <button id="btnBatchStart" class="btn">Iniciar ingest√£o</button>
          <button id="btnBatchStop" class="btn" disabled>Parar</button>
        </div>
      </div>

      <!-- üî∂ Cat√°logo (CSV Upload) -->
      <div class="tile">
        <h3>Cat√°logo (Upload CSV)</h3>
        <div class="inline">
          <input id="catFile" type="file" accept=".csv">
          <input id="catNsCsv" type="text" placeholder="namespace (opcional)">
          <button id="btnCatalogUpload" class="btn">Importar CSV</button>
        </div>
        <div class="progress"><div id="catCsvBar"></div></div>
        <div class="tiny" id="catCsvStats">‚Äî</div>
        <div class="list" id="catCsvList"></div>
        <div class="tiny">Formato flex√≠vel: deteta cabe√ßalhos comuns (name/title, summary/description, ref/sku, price, currency, iva_pct, brand, dimensions, material, image_url, url/link).</div>
      </div>

    </section>

    <!-- ====== SEC√á√ÉO GRANDE: Cat√°logo (Editor) ====== -->
    <section id="catalogEditor" class="catalog-editor">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
        <h2 style="margin:0;font-size:16px">Cat√°logo (Editor)</h2>
        <span id="catChangedBadge" class="badge-changed" style="display:none">Altera√ß√µes por gravar</span>
      </div>

      <div class="catalog-toolbar">
        <input id="catSearch" type="text" placeholder="filtrar por nome, resumo ou URL‚Ä¶" style="min-width:260px">
        <input id="catPageSize" type="number" value="50" min="10" max="500" step="10" style="width:110px" title="itens por p√°gina">
        <button id="catLoad" class="btn">Carregar</button>
        <div class="right">
          <button id="catSave" class="btn">Aplicar altera√ß√µes</button>
          <button id="catCopyPatch" class="btn">Copiar altera√ß√µes (JSON)</button>
        </div>
      </div>

      <div id="catTableWrap" style="max-height:540px;overflow:auto;border:1px solid var(--chip-br);border-radius:10px">
        <table id="catTable">
          <thead>
            <!-- CABE√áALHO AJUSTADO -->
            <tr>
              <th style="width:4%">#</th>
              <th style="width:10%">Ref</th>
              <th style="width:16%">Nome</th>
              <th style="width:22%">Resumo</th>
              <th style="width:14%">Variante</th>
              <th style="width:10%">Disponibilidade</th>
              <th style="width:9%">Pre√ßo</th>
              <th style="width:10%">Marca</th>
              <th style="width:18%">URL</th>
              <th style="width:8%">Fonte</th>
              <th style="width:11%">Atualizado</th>
              <th style="width:7%">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row" id="catPager2" style="margin-top:10px;align-items:center">
        <div class="tiny" id="catInfo2">‚Äî</div>
        <div class="right">
          <button id="catPrev2" class="btn">‚óÄ</button>
          <button id="catNext2" class="btn">‚ñ∂</button>
        </div>
      </div>
    </section>

  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const resultBox = $('#resultBox');
  const badgesBox = $('#summaryBadges');
  const taskLabel = $('#taskLabel');
  const svVersion = $('#sv-version');
  const svRag = $('#sv-rag');
  const svMem = $('#sv-mem');

  let timerInterval = null;
  function startTimer(){ const t0 = Date.now(); const el = $('#globalTimer');
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{ const s = Math.floor((Date.now()-t0)/1000);
      el.textContent = `‚è±Ô∏é ${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }, 200);
  }
  function stopTimer(){ clearInterval(timerInterval); }
  function setTask(t){ taskLabel.textContent = t || '‚Äî'; }
  function setBadges(list){ badgesBox.innerHTML=''; (list||[]).forEach(txt=>{ const b=document.createElement('div'); b.className='badge'; b.textContent=txt; badgesBox.appendChild(b);}); }
  function printResult(obj){ resultBox.textContent = (typeof obj==='string')?obj:JSON.stringify(obj,null,2); }
  function smallRes(el,obj){ el.textContent = (typeof obj==='string')?obj:JSON.stringify(obj,null,2); }

  async function loadHealth(){
    try{ const r = await fetch('/health'); const j = await r.json();
      svVersion.textContent = (j.model || '‚Äî'); svRag.textContent = j.rag_available ? 'dispon√≠vel' : 'off'; svMem.textContent = j.mem0_enabled ? 'on' : 'off';
    }catch{ svVersion.textContent='‚Äî'; svRag.textContent='‚Äî'; svMem.textContent='‚Äî'; }
  }
  loadHealth();

  function normalizeGoogleDriveLink(url){
    try{ const u=new URL(url);
      if (u.hostname!=='drive.google.com') return url;
      if (u.pathname==='/uc' && (u.searchParams.get('id')||u.searchParams.get('export'))) return url;
      const m=u.pathname.match(/\/file\/d\/([^/]+)/); if (m&&m[1]) return `https://drive.google.com/uc?export=download&id=${m[1]}`;
      if (u.pathname==='/open' && u.searchParams.get('id')) return `https://drive.google.com/uc?export=download&id=${u.searchParams.get('id')}`;
      return url;
    }catch(e){ return url; }
  }

  function readCommon(){ return {
    namespace: $('#ns').value.trim() || undefined,
    max_pages: parseInt($('#max_pages').value || '0',10) || undefined,
    deadline_s: parseInt($('#deadline_s').value || '0',10) || undefined,
    max_depth: parseInt($('#max_depth').value || '0',10) || undefined,
  };}

  async function postJSON(path, payload){
    const r = await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload||{})});
    let j; try{ j = await r.json(); }catch{ j = {ok:false, http_status:r.status}; }
    return j;
  }

  // ------- Tiles existentes -------
  $('#btnIngestSitemap').addEventListener('click', async ()=>{
    const sitemap_url = $('#sitemap_url').value.trim(); if (!sitemap_url) return;
    const p = readCommon();
    setTask(`a√ß√£o: ingest-sitemap   item: ${sitemap_url}`);
    setBadges([`Sitemap: ${sitemap_url}`, `namespace: ${p.namespace||'default'}`, `deadline_s: ${p.deadline_s||'‚Äî'}`, `max_pages: ${p.max_pages||'‚Äî'}`]);
    startTimer(); $('#btnIngestSitemap').disabled = true;
    const res = await postJSON('/rag/ingest-sitemap',{ sitemap_url, namespace:p.namespace, max_pages:p.max_pages, deadline_s:p.deadline_s });
    stopTimer(); $('#btnIngestSitemap').disabled = false; printResult(res); smallRes($('#resSitemap'),res);
  });

  $('#btnCrawl').addEventListener('click', async ()=>{
    const seed_url = $('#seed_url').value.trim(); if (!seed_url) return;
    const p = readCommon();
    setTask(`a√ß√£o: crawl   seed: ${seed_url}`);
    setBadges([`Seed: ${seed_url}`, `namespace: ${p.namespace||'default'}`, `deadline_s: ${p.deadline_s||'‚Äî'}`, `max_pages: ${p.max_pages||'‚Äî'}`, `max_depth: ${p.max_depth||'‚Äî'}`]);
    startTimer(); $('#btnCrawl').disabled = true;
    const res = await postJSON('/rag/crawl',{ seed_url, namespace:p.namespace, max_pages:p.max_pages, max_depth:p.max_depth, deadline_s:p.deadline_s });
    stopTimer(); $('#btnCrawl').disabled = false; printResult(res); smallRes($('#resCrawl'),res);
  });

  $('#btnIngestURL').addEventListener('click', async ()=>{
    let page_url = $('#single_url').value.trim(); if (!page_url) return;
    page_url = normalizeGoogleDriveLink(page_url); $('#single_url').value = page_url;
    const p = readCommon();
    setTask(`a√ß√£o: ingest-url   item: ${page_url}`);
    setBadges([`URL: ${page_url}`, `namespace: ${p.namespace||'default'}`]);
    startTimer(); $('#btnIngestURL').disabled = true;
    const res = await postJSON('/rag/ingest-url',{ page_url, namespace:p.namespace, deadline_s:p.deadline_s });
    stopTimer(); $('#btnIngestURL').disabled = false; printResult(res); smallRes($('#resURL'),res);
  });

  $('#btnIngestText').addEventListener('click', async ()=>{
    const title = $('#text_title').value.trim(); const text = $('#text_body').value.trim();
    if (!title || !text) return; const p = readCommon();
    setTask(`a√ß√£o: ingest-text   t√≠tulo: ${title}`); setBadges([`T√≠tulo: ${title}`, `namespace: ${p.namespace||'default'}`]);
    startTimer(); $('#btnIngestText').disabled = true;
    const res = await postJSON('/rag/ingest-text',{ title, text, namespace:p.namespace });
    stopTimer(); $('#btnIngestText').disabled = false; printResult(res); smallRes($('#resText'),res);
  });

  $('#btnIngestPDF').addEventListener('click', async ()=>{
    let pdf_url = $('#pdf_url').value.trim(); const title = $('#pdf_title').value.trim() || null;
    if (!pdf_url) return; pdf_url = normalizeGoogleDriveLink(pdf_url); $('#pdf_url').value = pdf_url;
    const p = readCommon(); setTask(`a√ß√£o: ingest-pdf-url   item: ${pdf_url}`);
    setBadges([`PDF: ${pdf_url}`, `namespace: ${p.namespace||'default'}`]);
    startTimer(); $('#btnIngestPDF').disabled = true;
    const res = await postJSON('/rag/ingest-pdf-url',{ pdf_url, title, namespace:p.namespace });
    stopTimer(); $('#btnIngestPDF').disabled = false; printResult(res); smallRes($('#resPDF'),res);
  });

  $('#btnSearch').addEventListener('click', async ()=>{
    const query = $('#search_q').value.trim(); const top_k = parseInt($('#search_topk').value || '6',10);
    const p = readCommon(); if (!query) return;
    setTask(`a√ß√£o: search   q: ${query}`); setBadges([`q: ${query}`, `namespace: ${p.namespace||'default'}`, `top_k: ${top_k}`]);
    startTimer(); $('#btnSearch').disabled = true;
    const res = await postJSON('/rag/search',{ query, namespace:p.namespace, top_k });
    stopTimer(); $('#btnSearch').disabled = false; printResult(res); smallRes($('#resSearch'),res);
  });

  $('#clearLogsBtn').addEventListener('click', ()=>{ printResult('{}'); setBadges([]); setTask('‚Äî'); });

  // ------- Extrair URLs (servidor com fallback cliente) -------
  $('#btnExtractSitemap').addEventListener('click', async ()=>{
    const sitemap_url = $('#sitemap_extract_url').value.trim();
    const outTA = $('#extractOutput'); const resBox = $('#resExtract');
    if (!sitemap_url) return;

    setTask(`a√ß√£o: extrair-urls   sitemap: ${sitemap_url}`);
    setBadges([`Sitemap: ${sitemap_url}`]); startTimer();
    $('#btnExtractSitemap').disabled = true; $('#btnCopyExtract').disabled = true;
    outTA.value = ''; resBox.textContent = 'A extrair‚Ä¶';

    // 1) tenta no servidor
    let usedServer = false;
    try{
      const srv = await postJSON('/rag/extract-urls', { url: sitemap_url, max_urls: 20000 });
      if (srv && srv.ok && Array.isArray(srv.urls) && srv.urls.length){
        usedServer = true;
        stopTimer();
        smallRes(resBox,{ via:'server', type:srv.type, count:srv.count, examples:srv.urls.slice(0,3) });
        outTA.value = srv.urls.join('\n');
        $('#btnCopyExtract').disabled = srv.urls.length===0;
        try{ await navigator.clipboard.writeText(outTA.value); }catch{}
        printResult({ ok:true, via:'server', count:srv.urls.length });
      }
    }catch(e){}

    // 2) fallback cliente
    if (!usedServer){
      try{
        async function fetchXml(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(`HTTP ${r.status}`); const t=await r.text(); return new DOMParser().parseFromString(t,'application/xml'); }
        const seen=new Set(), urls=[];
        async function walk(u){ if(seen.has(u)) return; seen.add(u);
          const doc=await fetchXml(u);
          urls.push(...[...doc.querySelectorAll('url > loc')].map(n=>n.textContent.trim()).filter(Boolean));
          for (const s of [...doc.querySelectorAll('sitemap > loc')].map(n=>n.textContent.trim()).filter(Boolean)) await walk(s);
        }
        await walk(sitemap_url);
        stopTimer();
        smallRes(resBox,{ via:'client', count:urls.length, examples:urls.slice(0,3) });
        outTA.value = urls.join('\n'); $('#btnCopyExtract').disabled = urls.length===0;
        try{ await navigator.clipboard.writeText(outTA.value); }catch{}
        printResult({ ok:true, via:'client', count:urls.length });
      }catch(e){
        stopTimer();
        smallRes(resBox,{ error:String(e && e.message || e) });
        printResult({ ok:false, error:String(e && e.message || e) });
      }
    }

    $('#btnExtractSitemap').disabled = false;
  });

  $('#btnCopyExtract').addEventListener('click', async ()=>{
    const txt = $('#extractOutput').value; if (!txt.trim()) return;
    try{ await navigator.clipboard.writeText(txt); printResult({ok:true,copied:true,lines:txt.split('\n').filter(Boolean).length}); }catch{ printResult({ok:false,error:'Clipboard bloqueado'}); }
  });

  // ------- Ingerir em lote -------
  const state = { stop:false };
  $('#btnBatchStart').addEventListener('click', async ()=>{
    const raw = $('#batchUrls').value.trim();
    const urls = raw.split(/[\s,]+/).map(s=>s.trim()).filter(Boolean);
    if (!urls.length) return;

    const commonNs = $('#ns').value.trim() || undefined;
    const ns = ($('#batchNamespace').value.trim() || commonNs);
    const deadline_s = parseInt($('#batchDeadline').value || '0',10) || undefined;
    const concurrency = Math.max(1, Math.min(10, parseInt($('#batchConcurrency').value || '3',10)));

    state.stop = false;
    $('#btnBatchStart').disabled = true;
    $('#btnBatchStop').disabled = false;
    setTask(`a√ß√£o: ingest-batch   urls: ${urls.length}`);
    setBadges([`namespace: ${ns||'default'}`, `concorr√™ncia: ${concurrency}`, `deadline_s: ${deadline_s||'‚Äî'}`]);
    startTimer();

    const list = $('#batchList'); list.innerHTML = '';
    const bar = $('#batchBar'); bar.style.width = '0%';
    const statsEl = $('#batchStats'); let done=0, ok=0, fail=0;

    function update(){
      const pct = Math.round((done/urls.length)*100);
      bar.style.width = pct + '%';
      statsEl.textContent = `${done}/${urls.length} ‚Ä¢ OK: ${ok} ‚Ä¢ Falhas: ${fail}`;
    }

    function addLine(text, cls){
      const div = document.createElement('div');
      if (cls) div.className = cls;
      div.textContent = text;
      list.appendChild(div);
      list.scrollTop = list.scrollHeight;
    }

    async function postJSON(path, payload){
      const r = await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload||{})});
      let j; try{ j = await r.json(); }catch{ j = {ok:false, http_status:r.status}; }
      return j;
    }

    async function ingestOne(u){
      const page_url = normalizeGoogleDriveLink(u);
      addLine(`‚Üí ${page_url}`);
      const res = await postJSON('/rag/ingest-url', { page_url, namespace: ns, deadline_s });
      if (res && (res.ok === true || res.status === 'ok')) { ok++; addLine(`‚úî OK ${page_url}`, 'ok'); }
      else { fail++; addLine(`‚úñ Falha ${page_url} :: ${JSON.stringify(res).slice(0,200)}`, 'err'); }
      done++; update();
    }

    let idx = 0, active = 0;
    await new Promise(resolve=>{
      const tick = ()=>{
        if (state.stop) { if (active===0) resolve(); return; }
        while (active < concurrency && idx < urls.length){
          const u = urls[idx++]; active++;
          ingestOne(u).finally(()=>{ active--; tick(); });
        }
        if (done >= urls.length && active === 0) resolve();
      };
      tick();
    });

    stopTimer();
    $('#btnBatchStart').disabled = false;
    $('#btnBatchStop').disabled = true;
    printResult({ ok:true, total: urls.length, ok, fail });
  });

  $('#btnBatchStop').addEventListener('click', ()=>{
    state.stop = true;
    $('#btnBatchStop').disabled = true;
  });

  // ------- üî∂ Cat√°logo: Upload CSV -------
  $('#btnCatalogUpload').addEventListener('click', async ()=>{
    const fileInput = $('#catFile');
    if (!fileInput.files.length) return;
    const file = fileInput.files[0];
    const ns = $('#catNsCsv').value.trim() || ($('#ns').value.trim() || undefined);

    setTask(`a√ß√£o: catalog-upload-csv`);
    setBadges([`ficheiro: ${file.name}`, `namespace: ${ns||'default'}`]);
    startTimer(); $('#btnCatalogUpload').disabled = true;

    const list = $('#catCsvList'); list.innerHTML = '';
    const bar = $('#catCsvBar'); bar.style.width = '0%';
    const statsEl = $('#catCsvStats'); statsEl.textContent = 'a enviar‚Ä¶';

    try {
      const form = new FormData();
      form.append('file', file);
      if (ns) form.append('namespace', ns);
      const r = await fetch('/catalog/import-csv',{ method:'POST', body: form });
      const j = await r.json().catch(()=>({ok:false}));
      stopTimer(); $('#btnCatalogUpload').disabled = false;

      if (j && j.ok){
        bar.style.width = '100%';
        const imported = (typeof j.imported==='number') ? j.imported : (j.count||0);
        const failed = (typeof j.failed==='number') ? j.failed : (j.errors||0);
        statsEl.textContent = `Importados: ${imported} ‚Ä¢ Falhas: ${failed}`;
        addLine(`‚úî Importa√ß√£o conclu√≠da (OK: ${imported} ‚Ä¢ Falhas: ${failed})`, 'ok');
        printResult(j);
        await loadCatalogEditor();
      } else {
        statsEl.textContent = 'Falha no upload';
        addLine(`‚úñ Erro: ${JSON.stringify(j).slice(0,200)}`, 'err');
        printResult({ok:false,server:j});
      }
    } catch(e){
      stopTimer(); $('#btnCatalogUpload').disabled = false;
      statsEl.textContent = 'Falha geral';
      addLine(`‚úñ Exce√ß√£o: ${String(e)}`, 'err');
      printResult({ok:false,error:String(e)});
    }

    function addLine(text, cls){
      const div=document.createElement('div');
      if (cls) div.className=cls;
      div.textContent=text;
      list.appendChild(div);
      list.scrollTop=list.scrollHeight;
    }
  });

  // ====== Cat√°logo (Editor) grande ======
  const Cat = {
    offset: 0, limit: 50, query: '',
    total: 0, items: [],
    originalById: new Map(),
    changes: new Map(), // id -> partial fields
  };

  function markChanged(id, field, value){
    const base = Cat.originalById.get(id) || {};
    const current = Object.assign({}, base, Cat.changes.get(id)||{});
    const baseVal = (current[field] ?? '');
    const newVal = (value ?? '');
    if (String(baseVal) === String(newVal)) {
      const patch = Cat.changes.get(id) || {};
      delete patch[field];
      if (!Object.keys(patch).length) Cat.changes.delete(id);
    } else {
      const patch = Cat.changes.get(id)||{};
      patch[field] = value;
      Cat.changes.set(id, patch);
    }
    $('#catChangedBadge').style.display = Cat.changes.size ? 'inline-block' : 'none';
  }

  function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function val(v, d=''){ return (v===undefined || v===null) ? d : v; }

  // NEW: helpers para extrair campos vis√≠veis da variante e disponibilidade
  function extractVariant(summary){
    if (!summary) return '';
    const m = /(?:^|\n)\s*Variante:\s*(.+)/i.exec(summary);
    return m ? m[1].trim() : '';
  }
  function extractAvailability(summary){
    if (!summary) return '';
    const m1 = /(?:^|\n)\s*Prazo\s*de\s*entrega:\s*(.+)/i.exec(summary);
    if (m1) return m1[1].trim();
    const m2 = /(?:^|\n)\s*Disponibilidade:\s*(.+)/i.exec(summary);
    return m2 ? m2[1].trim() : '';
  }

  async function loadCatalogEditor(){
    Cat.limit = Math.max(10, Math.min(500, parseInt($('#catPageSize').value||'50',10)));
    const url = `/catalog/list?q=${encodeURIComponent(Cat.query||'')}&limit=${Cat.limit}&offset=${Cat.offset}`;
    const r = await fetch(url);
    const j = await r.json().catch(()=>({ok:false}));
    const tb = $('#catTable tbody'); const info = $('#catInfo2');
    tb.innerHTML = '';
    Cat.items = [];
    Cat.originalById.clear();

    if (!j || j.ok === false || !Array.isArray(j.items)){
      tb.innerHTML = `<tr><td colspan="12">Falha a carregar cat√°logo.</td></tr>`;
      info.textContent = '‚Äî';
      return;
    }

    Cat.total = j.total || (j.items||[]).length + Cat.offset;

    (j.items||[]).forEach((row, idx)=>{
      // Mapeamento enxuto: sem imagem, moeda, IVA, dimens√µes, material
      const original = {
        id: row.id,
        ref: val(row.ref,''),
        name: val(row.name || row.title,''),
        summary: val(row.summary || row.snippet,''),
        price: val(row.price,''),
        brand: val(row.brand,''),
        url: val(row.url || row.link,''),
        source: val(row.source || row.host,''),
        updated_at: val(row.updated_at,'')
      };
      Cat.originalById.set(row.id, original);
      Cat.items.push(original);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${Cat.offset + idx + 1}</td>
        <td><input type="text" value="${escapeHtml(original.ref)}" data-id="${row.id}" data-field="ref"></td>
        <td><input type="text" value="${escapeHtml(original.name)}" data-id="${row.id}" data-field="name"></td>
        <td><textarea data-id="${row.id}" data-field="summary">${escapeHtml(original.summary)}</textarea></td>
        <td><input type="text" value="${escapeHtml(extractVariant(original.summary))}" readonly></td>
        <td><input type="text" value="${escapeHtml(extractAvailability(original.summary))}" readonly></td>
        <td><input type="number" step="0.01" placeholder="0.00" value="${escapeHtml(original.price)}" data-id="${row.id}" data-field="price"></td>
        <td><input type="text" value="${escapeHtml(original.brand)}" data-id="${row.id}" data-field="brand"></td>
        <td><input type="text" value="${escapeHtml(original.url)}" data-id="${row.id}" data-field="url"></td>
        <td><input type="text" value="${escapeHtml(original.source)}" data-id="${row.id}" data-field="source"></td>
        <td class="tiny">${escapeHtml(original.updated_at || '‚Äî')}</td>
        <td><button class="btn" style="padding:6px 10px" data-act="reset" data-id="${row.id}">Repor</button></td>
      `;
      tb.appendChild(tr);
    });

    // bind inputs edit√°veis
    tb.querySelectorAll('input[type=text][data-id], textarea[data-id], input[type=number][data-id]').forEach(el=>{
      el.addEventListener('input', (ev)=>{
        const id = parseInt(ev.target.dataset.id,10);
        const field = ev.target.dataset.field;
        const valx = ev.target.value;
        markChanged(id, field, valx);
      });
    });
    // bot√£o repor
    tb.querySelectorAll('button[data-act="reset"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = parseInt(btn.dataset.id,10);
        const orig = Cat.originalById.get(id);
        if (!orig) return;
        const row = btn.closest('tr');
        row.querySelectorAll('[data-id]').forEach(el=>{
          const f = el.dataset.field;
          el.value = orig[f] ?? '';
        });
        // recalcular campos derivados (Variante/Disponibilidade)
        const s = orig.summary || '';
        row.querySelectorAll('input[readonly]').forEach(el=>{
          const hdr = el.closest('td').previousElementSibling?.textContent || '';
        });
        const cells = row.querySelectorAll('td');
        // Variante = coluna 5 (index 4)
        cells[4].querySelector('input').value = extractVariant(s);
        // Disponibilidade = coluna 6 (index 5)
        cells[5].querySelector('input').value = extractAvailability(s);

        Cat.changes.delete(id);
        $('#catChangedBadge').style.display = Cat.changes.size ? 'inline-block' : 'none';
      });
    });

    const jItems = j.items || [];
    document.getElementById('catInfo2').textContent =
      `p√°gina: ${Math.floor(Cat.offset/Cat.limit)+1} ‚Ä¢ a mostrar ${ jItems.length } de ${Cat.total }${Cat.query?` ‚Ä¢ filtro: ‚Äú${Cat.query}‚Äù`:''}`;
  }

  // Toolbar editor
  $('#catLoad').addEventListener('click', ()=>{
    Cat.query = $('#catSearch').value.trim();
    Cat.offset = 0;
    loadCatalogEditor();
  });

  $('#catPrev2').addEventListener('click', ()=>{
    Cat.offset = Math.max(0, Cat.offset - Cat.limit);
    loadCatalogEditor();
  });

  $('#catNext2').addEventListener('click', ()=>{
    Cat.offset = Cat.offset + Cat.limit;
    loadCatalogEditor();
  });

  $('#catPageSize').addEventListener('change', ()=>{
    Cat.offset = 0;
    loadCatalogEditor();
  });

  // Copiar patch (JSON)
  $('#catCopyPatch').addEventListener('click', async ()=>{
    const patch = Array.from(Cat.changes.entries()).map(([id, fields]) => ({ id, ...fields }));
    const txt = JSON.stringify({ items: patch }, null, 2);
    try {
      await navigator.clipboard.writeText(txt);
      printResult({ ok: true, copied: true, count: patch.length });
    } catch {
      printResult({ ok: true, copied: false, count: patch.length, payload: patch });
    }
  });

  // Aplicar altera√ß√µes (POST /catalog/update se existir)
  $('#catSave').addEventListener('click', async ()=>{
    const patch = Array.from(Cat.changes.entries()).map(([id, fields]) => ({ id, ...fields }));
    if (!patch.length){
      printResult({ ok: true, message: 'Nada para gravar.' });
      return;
    }
    try {
      const r = await fetch('/catalog/update', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ items: patch })
      });
      if (r.status === 404){
        printResult({
          ok: false,
          error: "Endpoint /catalog/update n√£o existe no backend.",
          dica: "Usa ‚ÄúCopiar altera√ß√µes (JSON)‚Äù e aplica manualmente, ou cria o endpoint /catalog/update."
        });
        return;
      }
      const j = await r.json().catch(()=>({ ok:false }));
      if (j && j.ok !== false){
        Cat.changes.clear();
        $('#catChangedBadge').style.display = 'none';
        await loadCatalogEditor();
        printResult({ ok:true, saved:true, server:j });
      } else {
        printResult({ ok:false, server:j || {} });
      }
    } catch (e){
      printResult({ ok:false, error: String((e && e.message) || e) });
    }
  });

  // carregamento inicial do editor
  document.addEventListener('DOMContentLoaded', ()=>{ loadCatalogEditor(); });
})();
</script>
</body>
</html>
