<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Alma — entrada</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#0f0f11; --panel2:#141418;
    --fg:#f3f3f3; --muted:#b9bac0; --border:#26262b;
    --accent:#d4a017; /* amarelo torrado */
    --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    display:flex;align-items:center;justify-content:center;min-height:100vh;overflow:hidden;
  }
  .wrap{
    width:min(1200px, 94vw);
    display:grid;grid-template-columns:1.1fr .9fr;gap:28px;align-items:center;
  }
  @media (max-width: 900px){
    .wrap{grid-template-columns:1fr;gap:22px;padding:12px 0}
  }

  /* Avatar area */
  .stage{
    position:relative;aspect-ratio:16/10; border:1px solid var(--border);
    border-radius:16px; background:radial-gradient(1200px 700px at 80% -10%, rgba(212,160,23,.06), transparent 60%), #0b0b0c;
    box-shadow:var(--shadow); overflow:hidden;
  }
  #three{ position:absolute; inset:0; }
  .type{
    position:absolute; left:24px; bottom:20px;
    font-weight:800; letter-spacing:.5px;
    font-size: clamp(28px, 6vw, 72px); /* ~5x maior que normal */
    color:var(--fg); text-shadow:0 2px 24px rgba(0,0,0,.5);
    user-select:none; pointer-events:none; white-space:pre;
  }
  .cursor{
    display:inline-block; width:.6ch; margin-left:2px; background:var(--accent);
    animation:blink 1s steps(1, end) infinite;
  }
  @keyframes blink { 50%{opacity:0;} }

  /* Tiles */
  .tiles{
    display:grid; gap:14px;
  }
  .tile{
    display:flex; align-items:center; gap:12px;
    padding:16px 18px; border:1px solid var(--border);
    border-radius:14px; background:linear-gradient(180deg,var(--panel),var(--panel2));
    text-decoration:none; color:var(--fg);
    box-shadow:var(--shadow); transition:transform .12s ease, border-color .12s ease;
  }
  .tile:hover{ transform:translateY(-2px); border-color:var(--accent); }
  .badge{ font-weight:800; background:var(--accent); color:#111; padding:6px 10px; border-radius:999px; font-size:.9rem; }
  .sub{ font-size:.95rem; color:var(--muted); }

  .title{
    font-weight:800; font-size:1.6rem; margin:0 0 2px 0;
  }
  .vstack{ display:flex; flex-direction:column; gap:2px; }

  /* tiny footer */
  .tiny{
    margin-top:8px; font-size:.85rem; color:var(--muted); opacity:.85;
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Avatar + Typewriter -->
    <section class="stage">
      <div id="three" aria-hidden="true"></div>
      <div class="type" id="typeLine"></div>
    </section>

    <!-- Tiles -->
    <nav class="tiles" aria-label="entradas">
      <a class="tile" href="/alma-chat">
        <span class="badge">Escrever</span>
        <div class="vstack">
          <h3 class="title">Escrever com a Alma</h3>
          <div class="sub">Chat em modo consola, rápido e minimal.</div>
        </div>
      </a>

      <a class="tile" href="/voice">
        <span class="badge">Falar</span>
        <div class="vstack">
          <h3 class="title">Falar com a Alma</h3>
          <div class="sub">Voz↔voz e texto↦voz com lipsync.</div>
        </div>
      </a>

      <a class="tile" href="/console">
        <span class="badge">Data</span>
        <div class="vstack">
          <h3 class="title">Adicionar ao Alma Data</h3>
          <div class="sub">Sitemaps, páginas, PDFs e texto para o RAG.</div>
        </div>
      </a>

      <div class="tiny" id="warmNote">a preparar…</div>
    </nav>
  </div>

  <!-- Three / GLTFLoader via ESM (CDN) -->
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.1/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.1/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://unpkg.com/three@0.160.1/examples/jsm/loaders/GLTFLoader.js";

    // ===== AVATAR URL =====
    const qs = new URLSearchParams(location.search);
    const AVATAR_URL =
      qs.get("avatar") ||
      // coloca aqui o MESMO link público que já funciona no alma-frontend:
      "https://models.readyplayer.me/68ac391e858e75812baf48c2.glb?morphTargets=ARKit";

    // ===== Cenário básico =====
    const host = document.getElementById("three");
    const w = host.clientWidth, h = host.clientHeight;
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0b0c);

    const camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 100);
    camera.position.set(0, 1.55, 2.05);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
    renderer.setSize(w,h); renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    host.appendChild(renderer.domElement);

    // Luz
    const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
    hemi.position.set(0,2,0); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(2,4,2); scene.add(dir);

    // Controlo (desativado para a intro)
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enabled = false;

    // ===== Carregar GLB =====
    const loader = new GLTFLoader();
    loader.setCrossOrigin("anonymous");

    let avatar = null;
    let smileTargets = [];      // índices de smile L/R
    let mouthTargets = [];      // índices de boca (jawOpen, etc.)

    function findMorphIndex(mesh, names){
      if (!mesh.morphTargetDictionary) return -1;
      for (const n of names){
        const i = mesh.morphTargetDictionary[n];
        if (typeof i === "number") return i;
      }
      return -1;
    }

    loader.load(AVATAR_URL, (gltf)=>{
      avatar = gltf.scene;
      // esconder mãos (opcional)
      avatar.traverse(o=>{
        const nm = (o.name||"").toLowerCase();
        if (nm.includes("hand") || nm.includes("wrist") || nm.includes("wolf3d_hands")) o.visible=false;
        if (o.isMesh && o.material?.isMeshStandardMaterial){
          o.material.roughness = 0.75; o.material.metalness = 0.05;
        }
      });

      // normalizar escala
      const box = new THREE.Box3().setFromObject(avatar);
      const size = new THREE.Vector3(); box.getSize(size);
      const hM = size.y || 1;
      avatar.scale.setScalar(1.75 / hM);
      scene.add(avatar);

      // recolher morphs
      avatar.traverse(obj=>{
        if (obj.isMesh && obj.morphTargetDictionary && obj.morphTargetInfluences){
          const smileL = findMorphIndex(obj, ["mouthSmileLeft"]);
          const smileR = findMorphIndex(obj, ["mouthSmileRight"]);
          const jaw   = findMorphIndex(obj, ["jawOpen","mouthOpen","viseme_aa","MouthOpen"]);

          if (smileL>=0 || smileR>=0) smileTargets.push({mesh:obj, L:smileL, R:smileR});
          if (jaw>=0) mouthTargets.push({mesh:obj, J:jaw});
        }
      });

      // posicionar a câmara ao busto
      fitCamera();

      // correr a intro: 360º eixo Y → sorrir → typewriter
      runIntro().then(()=> startTypewriter());
    }, undefined, (err)=>{
      console.error("Falha a carregar GLB:", err);
      // mesmo que falhe GLB, mostra o texto
      startTypewriter();
    });

    function fitCamera(){
      const box = new THREE.Box3().setFromObject(avatar);
      const size = new THREE.Vector3(), center = new THREE.Vector3();
      box.getSize(size); box.getCenter(center);
      const target = center.clone(); target.y += size.y*(0.72-0.5);
      const fov = camera.fov * Math.PI/180;
      const height = size.y * 0.95;
      const width  = size.x * 0.95;
      const distH = height/(2*Math.tan(fov/2));
      const distW = width /(2*Math.tan((fov*camera.aspect)/2));
      const dist  = Math.max(distH, distW)*0.58;
      const dirV = new THREE.Vector3(0,0.12,1).normalize();
      const pos = target.clone().add(dirV.multiplyScalar(dist));
      camera.position.copy(pos);
      camera.near = Math.max(0.01, dist/100); camera.far = dist*100;
      camera.updateProjectionMatrix();
      controls.target.copy(target);
    }

    // ===== Intro =====
    async function runIntro(){
      // 1) rotação Y 0→2π (~2.2s)
      const start = performance.now();
      const dur = 2200;
      return new Promise(resolve=>{
        const spin = (t)=>{
          const k = Math.min(1, (t-start)/dur);
          if (avatar) avatar.rotation.y = k * Math.PI*2;
          renderer.render(scene,camera);
          if (k<1) requestAnimationFrame(spin); else {
            if (avatar) avatar.rotation.y = 0; // olha em frente
            // 2) sorriso suave (0.6s)
            const s0 = performance.now(), sd=600;
            const smileStep = (tt)=>{
              const kk = Math.min(1, (tt-s0)/sd);
              for (const st of smileTargets){
                const infl = st.mesh.morphTargetInfluences;
                if (infl && st.L>=0) infl[st.L] = 0.25*kk;
                if (infl && st.R>=0) infl[st.R] = 0.25*kk;
              }
              renderer.render(scene,camera);
              if (kk<1) requestAnimationFrame(smileStep); else resolve();
            };
            requestAnimationFrame(smileStep);
          }
        };
        requestAnimationFrame(spin);
      });
    }

    // ===== Loop render =====
    let raf=0; const tick=()=>{
      controls.update();
      renderer.render(scene,camera);
      raf = requestAnimationFrame(tick);
    }; tick();

    // resize
    new ResizeObserver(()=>{
      const W = host.clientWidth, H = host.clientHeight;
      camera.aspect = W/H; camera.updateProjectionMatrix();
      renderer.setSize(W,H);
    }).observe(host);

    // ===== Typewriter =====
    const lineEl = document.getElementById("typeLine");
    function startTypewriter(){
      const text = "> olá, sou a Alma";
      lineEl.textContent = "";
      let i=0;
      const step=()=> {
        if (i<=text.length){
          lineEl.innerHTML = text.slice(0,i) + '<span class="cursor"></span>';
          i++; setTimeout(step, i<4 ? 90 : 55);
        } else {
          lineEl.innerHTML = text; // sem cursor no fim
        }
      };
      step();
    }

    // ===== Pré-aquecimento silencioso =====
    (async ()=>{
      try { await fetch("/health", {cache:"no-store"}); } catch {}
      try { await fetch("/ping_grok", {cache:"no-store"}); } catch {}
      // nota discreta por 1.5s
      const n = document.getElementById("warmNote");
      n.textContent = "pronto.";
      setTimeout(()=>{ n.textContent=""; }, 1500);
    })();

  </script>
</body>
</html>
