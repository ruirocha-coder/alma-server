<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Alma — entrada</title>
<style>
  :root{
    --bg:#0a0a0b; --panel:#0b0b0d;
    --fg:#f3f3f3; --muted:#b9bbc2;
    --accent:#d4a017; --border:#24242a;
    --glow:0 14px 40px rgba(0,0,0,.40);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:32px 18px;display:flex;flex-direction:column;align-items:center}

  /* ===== Avatar stage (sem moldura) ===== */
  .stage{
    width:clamp(320px,34vw,520px);
    height:clamp(260px,34vw,420px);
    margin:8px auto 0;
    position:relative; overflow:hidden; border-radius:18px;
    background:radial-gradient(900px 450px at 80% -10%, rgba(212,160,23,.05), transparent 60%), var(--panel);
    box-shadow:var(--glow);
  }
  #avatarCanvas{position:absolute; inset:0}
  .spinner{position:absolute; inset:0; display:grid; place-items:center}
  .spinner::before{
    content:""; width:38px; height:38px; border-radius:50%;
    border:4px solid rgba(212,160,23,.25); border-top-color:var(--accent);
    animation:spin 1s linear infinite
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== Typewriter ===== */
  .typewrap{width:min(1000px,100%); margin:18px auto 0; text-align:center}
  .type{
    font-weight:900; letter-spacing:-0.5px; line-height:1.06;
    font-size:clamp(32px,7vw,72px); white-space:pre-wrap; user-select:none; margin:0;
  }
  .type .prompt{opacity:.6}
  .cursor{display:inline-block;width:.6ch;background:currentColor;animation:blink 1s steps(1,end) infinite}
  @keyframes blink{50%{opacity:0}}

  /* ===== Tiles ===== */
  .tiles{
    width:min(1100px,100%);
    display:grid; grid-template-columns:repeat(3,1fr); gap:16px;
    margin:22px auto 6px;
  }
  @media (max-width:900px){ .tiles{grid-template-columns:1fr} }
  .tile{
    display:flex; flex-direction:column; gap:6px;
    padding:18px; border-radius:14px; text-decoration:none; color:var(--fg);
    background:linear-gradient(180deg,#0f0f11,#141418);
    border:1px solid var(--border); box-shadow:var(--glow);
    transition:border-color .15s ease;
  }
  .tile:hover{ border-color: var(--accent); }
  .tile h3{margin:0 0 4px 0; font-size:18px}
  .tile p{margin:0; color:var(--muted); font-size:14px}
</style>

<!-- three + addons (mantidos) -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.1/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.1/examples/jsm/"
  }
}
</script>
</head>
<body>
  <div class="wrap">
    <!-- AVATAR -->
    <section class="stage" aria-label="Alma avatar 3D">
      <div id="avatarCanvas"></div>
      <div class="spinner" id="spin"></div>
    </section>

    <!-- TYPEWRITER (arranca só após animação do avatar) -->
    <div class="typewrap">
      <h1 class="type" id="type"><span class="prompt">&gt; </span></h1>
    </div>

    <!-- TILES (texto apenas) -->
    <nav class="tiles">
      <a class="tile" href="/alma-chat">
        <h3>Escrever com a Alma</h3>
        <p>Chat em modo consola, rápido e minimal.</p>
      </a>
      <a class="tile" href="/alma-frontend">
        <h3>Falar com a Alma</h3>
        <p>Voz→voz e texto→voz, com lipsync.</p>
      </a>
      <a class="tile" href="/console">
        <h3>Adicionar ao Alma Data</h3>
        <p>Sitemaps, páginas, PDFs e texto para o RAG.</p>
      </a>
    </nav>
  </div>

<script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { KTX2Loader } from 'three/addons/loaders/KTX2Loader.js';
  import { MeshoptDecoder } from 'three/addons/libs/meshopt_decoder.module.js';

  // ---------- config ----------
  const qs = new URLSearchParams(location.search);
  const AVATAR_URL =
    qs.get('avatar') ||
    'https://models.readyplayer.me/68ac391e858e75812baf48c2.glb?morphTargets=ARKit';

  const stage = document.querySelector('.stage');
  const container = document.getElementById('avatarCanvas');
  const spinner = document.getElementById('spin');

  // ---------- typewriter (começa depois da animação) ----------
  const TYPE_TEXT = "Olá, sou a Alma";
  const typeEl = document.getElementById('type');
  function startTypewriter(){
    let i=0;
    (function tick(){
      if (i <= TYPE_TEXT.length){
        typeEl.innerHTML = `<span class="prompt">&gt; </span>${TYPE_TEXT.slice(0,i)}<span class="cursor">&nbsp;</span>`;
        i++; setTimeout(tick, i<3 ? 120 : 42);
      } else {
        typeEl.innerHTML = `<span class="prompt">&gt; </span>${TYPE_TEXT}`;
      }
    })();
  }

  // ---------- THREE setup (centragem igual ao AvatarCanvas) ----------
  const scene = new THREE.Scene();
  scene.background = new THREE.Color('#0b0b0d');

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  container.appendChild(renderer.domElement);

  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
  camera.position.set(0, 1.6, 2.0);

  function resize(){
    const w = stage.clientWidth, h = stage.clientHeight;
    renderer.setSize(w,h,false);
    camera.aspect = w/h; camera.updateProjectionMatrix();
  }
  resize(); addEventListener('resize', resize, {passive:true});

  // luzes
  scene.add(new THREE.HemisphereLight(0xffffff,0x222233,1.0));
  const dir = new THREE.DirectionalLight(0xffffff,1.0);
  dir.position.set(2,4,2); scene.add(dir);

  // loaders
  const ktx2 = new KTX2Loader()
    .setTranscoderPath('https://unpkg.com/three@0.160.1/examples/jsm/libs/basis/')
    .detectSupport(renderer);

  const loader = new GLTFLoader();
  loader.setCrossOrigin('anonymous');
  loader.setKTX2Loader(ktx2);
  loader.setMeshoptDecoder(MeshoptDecoder);

  // helpers
  function lerp(a,b,t){ return a + (b-a) * Math.max(0, Math.min(1,t)); }

  function fitCameraToObject(object, {padding=0.95, yFocusBias=0.72, zoomFactor=0.58}={}){
    const box = new THREE.Box3().setFromObject(object);
    const size = new THREE.Vector3(); const center = new THREE.Vector3();
    box.getSize(size); box.getCenter(center);

    const target = center.clone();
    target.y += size.y * (yFocusBias - 0.5);

    const fov = (camera.fov * Math.PI) / 180;
    const distForHeight = (size.y * padding) / (2 * Math.tan(fov / 2));
    const distForWidth  = (size.x * padding) / (2 * Math.tan((fov * camera.aspect) / 2));
    const distance = Math.max(distForHeight, distForWidth) * zoomFactor;

    const dir = new THREE.Vector3(0, 0.12, 1).normalize();
    const newPos = target.clone().add(dir.multiplyScalar(distance));

    camera.position.copy(newPos);
    camera.near = Math.max(0.01, distance / 100);
    camera.far  = distance * 100;
    camera.updateProjectionMatrix();
    camera.lookAt(target);
  }

  // ---------- load avatar ----------
  let avatar=null;

  loader.load(
    AVATAR_URL,
    (gltf)=>{
      avatar = gltf.scene;

      // esconder mãos & afinar materiais
      avatar.traverse((o)=>{
        const n=(o.name||'').toLowerCase();
        if (n.includes('hand') || n.includes('wrist') || n.includes('wolf3d_hands')) o.visible=false;
        if (o.isMesh && o.material?.isMeshStandardMaterial){
          o.material.roughness=0.75; o.material.metalness=0.05;
        }
      });

      // === normalizar altura e recentrar como no AvatarCanvas ===
      // 1) bounding box / scale para ~1.75m
      const tmpBox = new THREE.Box3().setFromObject(avatar);
      const tmpSize = new THREE.Vector3(); const tmpCenter = new THREE.Vector3();
      tmpBox.getSize(tmpSize); tmpBox.getCenter(tmpCenter);
      const heightM = tmpSize.y || 1;
      const desired = 1.75;
      avatar.scale.setScalar(desired / heightM);

      // 2) trazer o centro do modelo para a origem (ficar “bem no meio”)
      avatar.position.sub(tmpCenter);

      // 3) meter na cena
      scene.add(avatar);

      // focar rosto e enquadrar
      fitCameraToObject(avatar, {padding:0.95, yFocusBias:0.72, zoomFactor:0.58});

      // preparar sorriso (morphs ARKit)
      const smileNames = ["mouthSmileLeft", "mouthSmileRight", "smileLeft", "smileRight"];
      const mMeshes=[]; const mIdx=[];
      avatar.traverse(obj=>{
        if (obj.isMesh && obj.morphTargetDictionary && obj.morphTargetInfluences){
          for(const n of smileNames){
            const id = obj.morphTargetDictionary[n];
            if (typeof id === "number"){ mMeshes.push(obj); mIdx.push(id); break; }
          }
        }
      });

      // animação: vira da esquerda -> frente e, no fim, sorri
      avatar.rotation.y = -Math.PI/2; // esquerda
      const t0 = performance.now(); const dur = 1200;
      (function anim(){
        const t = Math.min(1, (performance.now()-t0)/dur);
        const e = 1 - Math.pow(1-t, 3); // easeOutCubic
        avatar.rotation.y = -Math.PI/2 * (1-e);
        for(let i=0;i<mMeshes.length;i++){
          const infl = mMeshes[i].morphTargetInfluences;
          infl[mIdx[i]] = lerp(infl[mIdx[i]]||0, Math.min(0.35, e*0.4), 0.2);
        }
        camera.lookAt(0, 1.5, 0);
        if (t<1) requestAnimationFrame(anim);
        else { spinner.style.display='none'; startTypewriter(); }
      })();
    },
    undefined,
    (err)=>{ console.warn('GLB falhou:', err); spinner.style.display='none'; startTypewriter(); }
  );

  // render loop
  (function tick(){ renderer.render(scene,camera); requestAnimationFrame(tick); })();

  // ---------- pré-aquecimento silencioso ----------
  (async ()=>{
    try{ await Promise.race([fetch('/health',{cache:'no-store'}), new Promise(r=>setTimeout(r,1000))]); }catch{}
    try{ await Promise.race([fetch('/ping_grok',{cache:'no-store'}), new Promise(r=>setTimeout(r,1200))]); }catch{}
    try{ fetch('/alma-chat',{cache:'no-store'}).catch(()=>{}); }catch{}
    try{
      fetch('/ask',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({question:'(warmup) diz "ok"', user_id:'warmup'})
      }).catch(()=>{});
    }catch{}
  })();
</script>
</body>
</html>
